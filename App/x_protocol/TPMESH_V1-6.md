# TPUNB 模组 NM 2 - TPMesh 模组使

# 用说明书 v 1. 6


## 目 录



- 1 .产品特点.................................................................................................
- 2 .快速入门.................................................................................................
- 3 .产品功能.................................................................................................
   - 3 1 .通信地址定义................................................................................................
   - 3 2 .按需组网........................................................................................................
   - 3 3 .多中心节点....................................................................................................
   - 3 4 .多备选路径....................................................................................................
   - 3 5 .路径优化........................................................................................................
   - 3 6 .跳频通信........................................................................................................
   - 3 7 .发送对象........................................................................................................
   - 3 8 .送达确认模式................................................................................................
   - 3 9 .功耗模式......................................................................................................
   - 3 10 .低功耗组网................................................................................................
   - 3 11 .大文件代理传输.........................................................................................
      - 3 11 1 .文件传输工具功能介绍..................................................................
   - 3 12 .数据透传模式............................................................................................
      - 3 12 1 .邻居透传.........................................................................................
      - 3 12 2 .隐藏地址定向透传.........................................................................
      - 3 12 3 .显式地址定向透传.........................................................................
      - 3 12 4 .指定地址偏移透传.........................................................................
   - 3 13 .射频测试模式（生产测试）....................................................................
      - 3 13 1 .指令简介.........................................................................................
      - 3 13 2 .测试介绍.........................................................................................
      - 3 13 3 .底噪扫描.........................................................................................
   - 3 14 .参考指标....................................................................................................
      - 3 14 1 .时延.................................................................................................
      - 3 14 2 .待机功耗.........................................................................................
      - 3 14 3 .发送功耗.........................................................................................
- 1 .AT指令详细描述.................................................................................
   - 1 1 .AT接口配置.................................................................................................
   - 1 2 .AT指令.........................................................................................................
   - 1 3 .命令格式......................................................................................................
   - 1 4 .命令分类说明..............................................................................................
   - 1 5 .通用指令......................................................................................................
      - 1 5 1 AT...................................................................................................
      - 1 5 2 配置AT串口UART........................................................................
      - 1 5 3 查询AT串口UART........................................................................
      - 1 5 4 查询固件版本VER........................................................................
      - 1 5 5 进入AT模式+++...........................................................................
      - 1 5 6 软重启REBOOT..............................................................................
      - 1 5 7 查询ESN........................................................................................
      - 1 5 8 进入透传模式EXIT......................................................................
   - 1 6 配置指令...................................................................................................
      - 1 6 1 .配置通信地址ADDR.......................................................................
      - 1 6 2 .查询通信地址ADDR.......................................................................
      - 1 6 3 .配置小区ID......................................................................................
      - 1 6 4 .查询小区ID......................................................................................
      - 1 6 5 .配置唤醒周期WOR.........................................................................
      - 1 6 6 .查询唤醒周期WOR.........................................................................
      - 1 6 7 .配置功耗模式LP..............................................................................
      - 1 6 8 .查询功耗模式LP..............................................................................
      - 1 6 9 .配置透传参数TRANS.....................................................................
      - 1 6 10 .查询透传参数TRANS...................................................................
      - 1 6 11 .配置私有会话KEY........................................................................
      - 1 6 12 .查询私有会话KEY........................................................................
- 1 7 .通信指令......................................................................................................
   - 1 7 1 数据发送SEND..............................................................................
- 1 8 .URC指示.....................................................................................................
   - 1 8 1 模组完成重启...............................................................................
   - 1 8 2 模组AT接口就绪.........................................................................
   - 1 8 3 路由创建.......................................................................................
   - 1 8 4 路由删除.......................................................................................
   - 1 8 5 模组进入休眠...............................................................................
   - 1 8 6 模组退出休眠...............................................................................
   - 1 8 7 数据接收.......................................................................................
   - 1 8 8 数据发送过程...............................................................................
   - 1 8 9 送达确认.......................................................................................
   - 1 8 10 泛洪数据接收.............................................................................
- 1 9 .运维指令......................................................................................................
   - 1 9 1 .查询邻居信息NB.............................................................................
   - 1 9 2 .查询路由信息RT..............................................................................
   - 1 9 3 .查询OTA状态..................................................................................
   - 1 9 4 .添加静态路由ADDRT.....................................................................
   - 1 9 5 .删除路由DELRT..............................................................................
   - 1 9 6 .更新邻居信息NB.............................................................................
   - 1 9 7 .查询邻居信息（简短版）NB..........................................................
   - 1 9 8 .链路PINGPONG.............................................................................
- 1 10 .文件传输....................................................................................................
   - 1 10 1 文件提取通知FILE....................................................................
   - 1 10 2 .提取通知回复.................................................................................
   - 1 10 3 .提取文件数据.................................................................................
   - 1 10 4 .OTA本地交互NOTA.....................................................................


## 1 .产品特点.................................................................................................

 TPMesh自组网组网协议

```
 无需提前组网，按需发现路由
 支持多中心节点
 确定性路由，多备选路径
 动态路径优化
 跳频通信
 支持广播、组播、点播、泛洪传输
 支持低功耗组网场景
```
 支持频段 470 MHz～ 510 MHz

 支持空中唤醒

 AT指令配置, AT指令发送/数据透传

 支持大文件代理传输

 2. 6 ～ 3. 6 V电源供电

## 2 .快速入门.................................................................................................

TPMesh是一种源触发的按需路由方案，其主体思想是设备无需先注册，当
需要发送数据时，如果不存在到目标节点的有效路径时，可以发起寻找目标节
点的路由发现报文，当目标节点收到路由发现报文后应答路由回复报文，此时
路由便建立起来，可以正常通信；
网络中设计的设备分为三种角色：中心节点，路由节点，叶子节点。
中心节点：整个网络允许存在多个，具备全部路由的全路径信息，提供运


##### 维，诊断等手段维护网络拓扑；

##### 路由节点：具备到中心节点的全路径信息，负责为上位机提供业务数据收

##### 发通道，额外承担业务数据的转发，路由维护的功能；

##### 叶子节点：具备到中心节点的全路径信息，负责为上位机提供业务数据收

##### 发通道，不承担业务转发功能；

当每个节点都是中心节点时，网络为纯mesh网络；
当若干个节点时中心节点时，网络为多中心树形网络；
路由节点和叶子节点通常可以相互转换，在特定的使用场景下可以对部分
节点强行配置为叶子节点从而达到低功耗的需求；
节点的身份由配置的通信地址决定；

TPMesh模块工作的频段为： 470 MHz～ 510 MHz。使用串口进行数据收发，降
低了无线应用的门槛，可实现一对一，一对多，多对多的通信，轻松满足各种
组网需求。

##### 收发测试：

##### 本例采用如下参数进行配置：

##### 参数 模组A（中心节点） 模组B（普通节点）

节点地址 0 xFFFE 0 x 1111

##### 1. 使用串口分别将模组A和模组B接入PC机（AT串口）；

##### 2. 启动两个串口工具软件，选择对应 AT 串口号，点击打开串口

（ 115200 bps, 8 N 1 ）
3. 开始配置
( 1 )通过AT+ADDR指令配置通信地址；


##### ( 2 )通过AT+CELL配置业务小区（可选）；

##### 4 .收发测试

##### ( 1 ) 模组B发送业务数据给模组A；

##### ( 2 ) 模组A接收业务数据；


## 3 .产品功能.................................................................................................

##### 基本功能框图：

##### 网络拓扑图：

##### ·支持中心节点到任意节点通信，如FFFE-- 0005 - - 0009 ；

##### ·支持普通节点间通信，无需强行交付到中心节点转发，如 0009 - - 0006 - -

##### 0007 ；

##### ·支持普通节点通过任意中心节点地址找到具备北向出口的中心节点，如

##### 0009 - - 0005 - -FFFE/ 0009 - - 0005 - -FFFD;


### 3 1 .通信地址定义................................................................................................

##### 通信地址由上位机配置提供，使用 2 字节标识，通信地址的配置决定了模

##### 组在网络中的角色，通信地址使用规则如下：

##### 地址范围 描述

```
0 xFFFF 任意中心节点
0 xFFFE~ 0 xFFBE 中心节点地址范围/纯MESH模式地
址段
0 xFFBD~ 0 xFF 7 D 组播地址
0 xFF 7 C~ 0 xFF 00 保留
0 x 0000 广播地址
0 x 0001 ~ 0 xFEFF 普通节点地址/纯MESH模式地址段
```
### 3 2 .按需组网........................................................................................................

##### 当需要组建一个自组网时，即节点充当网络中的汇聚角色，做以下步骤：

##### 1 ）配置小区号，类似业务切片，用于区分不同业务的通信；

(^2) ）配置中心节点段的通信地址；
3 ）等待下游节点的路由建立或者主动向下游节点发送业务报文；

##### 当一个新的节点需要加入到已有的自组网时，做以下步骤：

##### 1 ）配置小区号，用于识别不同的业务切片；

(^2) ）配置普通节点段的通信地址；
3 ）发送业务报文；
a. 当普通节点不清楚中心节点的具体通信地址时，可以在发送指令中
指示目标地址为任意中心节点（ 0 xFFFF）就可以与中心节点建立通信
（AT+SEND=FFFF,len,data,type），建立成功后会通过URC推送告知上位
机具体的中心节点地址（+ROUTE:CREATE ADDR[ 0 xFFXX]）；
b. 当普通节点已经建立与中心节点的路由关系后，依然可以使用任意


```
中心节点( 0 xFFFF)通信或者指定具体的中心节点地址通信；
```
### 3 3 .多中心节点....................................................................................................

##### 本网络中至少存在一个中心节点，当然也支持多个中心节点的存在；

##### 当网络中存在多个中心节点时，中心节点间是允许相互通信的；

##### 当节点发起任意中心节点的路由发现时，会收到多个中心节点的路由应答，

##### 此时节点的后续数据的目标地址如果仍然是任意中心节点时，节点会选择距离

##### 本节点跳数最少的一个中心节点发送；

##### 当所有节点都是中心节点时，此时网络就变为纯MESH网络；

### 3 4 .多备选路径....................................................................................................

##### 在本路由方案中，允许保留到目标节点的多条有效路径，每次发送时都会

##### 选择最优路径进行发送，当传送过程中发现路径不可达时，会选择另外的备选

##### 路径进行数据的送达，从而增加数据的可达性；

##### 比如 0007 存在 2 条到FFFE的路径：

##### · 0007 - - 0006 - - 0005 - -FFFE


##### · 0007 - - 0006 - - 0009 - - 0005 - -FFFE

##### ·当遇到不可达下一跳时（比如 0006 到 0005 被遮挡导致不可达），会选择备

##### 选路径（ 0007 - - 0006 - - 0009 - - 0005 - -FFFE）进行数据的转发

### 3 5 .路径优化........................................................................................................

##### 路径的优化对于网络的稳定性和性能来说都是重要的存在，本方案中通过

##### 以下几个维度进行路径的优化：

##### 1 ）基于邻居信息的更新

##### 节点间会通过MAC层的通信握手交换路由状态，利用空口信号的特点，

##### 节点可以偷听到邻居的握手信息，从而更新自己的路由信息；如节点X

##### 到中心节点A的路径是X-C-B-A，现在在X节点附近新增了一个节点

##### Y，其中Y可以直达中心节点A，在Y和A交互过程中，X偷听到Y

##### 和A的握手信息，得知Y存在更加短的路径时，X就会向Y的方向尝

##### 试建立到A的路由，从而实现路径的动态优化；

##### 2 ）基于电量的路径均衡

##### 每个节点在工作时都会记录自己的收发工况从而推断自身的耗电情况，

##### 依据耗电百分比来决定转发意愿，当一个节点的电量消耗较大时，转发

##### 意愿就会降低，在与其他节点握手的过程中告知邻居，让邻居选择转发

##### 意愿更高的节点转发，从而实现基于电量的路径均衡；

##### 3 ）手动配置静态路径

##### 业务的运营方可以依据业务特性进行路径的静态配置，通过中心节点就

##### 可以把静态路径配置下去。

### 3 6 .跳频通信........................................................................................................

```
本方案支持 470 MHz~ 510 MHz的全频段跳频通信，从而提高抗干扰能力；
节点间通信是通过握手信道进行初步协商，然后在数据信道进行数据收
发，最终回到握手信道进行数据确认，基于上述的基本通信逻辑，把跳频
分为握手跳频和数据跳频；
```

##### 利用无线特性，握手信道会从每个频段中挑选一个出来，节点在发送握

##### 手信号时随机从握手信道中挑选一个，等待邻居应答后，就会从剩余的频

##### 点中协商一个信道作为后续的数据收发信道。

##### 由于每次的数据信道（含重传）都是依据可靠通信策略选择的不同频点，

##### 可以在无线环境较为复杂的环境下提高通信的成功率。

### 3 7 .发送对象........................................................................................................

##### 依据业务数据发送的对象不同，可以分为以下几种：

##### 1 ）点播发送

```
a. 最为常见的发送方式，由一端发起给另外一端的通信方式，经过路
由节点进行定向数据转发；
b. 节点不管是什么角色，都可以向指定地址的另外一个节点进行点播
通信，无需强行交由中心节点进行转发；
c. 提供任意中心地址的方式让节点轻易找到北向出口；
2 ）组播发送
a. 每个节点都可以配置一个组播地址；
b. 当节点发送指定组地址的组播报文时，属于该组地址的其他节点接
收并处理报文，其余节点依据自身条件转发该报文；
c. 每个节点都可以发送组播报文，只是传播的范围有所不同，中心节
点发送的组播报文可以辐射整个网络，而普通节点发送的组播报文仅限于
其邻居；
3 ）广播发送
a. 当节点收到广播报文时，其余节点接收并处理广播报文，并且依据
自身条件转发该报文；
b. 每个节点都可以发送广播报文，只是传播的范围有所不同，中心节
点发送的广播报文可以辐射整个网络，而普通节点发送的广播报文仅限于
其邻居；
4 ）泛洪发送
a. 当节点发送泛洪报文时，目标地址节点都会收到相同的泛洪报文；
```

```
b. 不受制于网络拓扑，就在邻居间进行数据的传递；
c. 当节点收到泛洪报文时，目标地址接收并处理泛洪报文，全部节点
依据自身的条件转发该报文；
```
### 3 8 .送达确认模式................................................................................................

##### 假如网络拓扑为A-B-C-D-E，当A发送数据给E时，本方案中提供了以下

##### 两种数据送达确认模式：

##### 1 ）UM，数据交付给目标节点后，目标节点无需回应送达确认报文给源节

##### 点，通信可靠性依赖邻居节点间的握手机制（节点间可靠，全链路不可靠）；

```
a. A发送给B后知道B已经成功接收到数据，但是后续节点如何就依
靠节点间的可靠传输机制决定，所以此时 A收到 B的接收应答
（+SEND:sn,SEND OK）时，认为已经发送成功，实际上E是否收到不确定；
```
##### 2 ）AM，数据交付给目标节点后，目标节点需回应送达确认报文给源节点，

##### 通信可靠性依赖邻居节点间的握手机制（节点间可靠，全链路可靠）；

```
a. A发送给B后知道B已经成功接收，最后数据经过中间节点转发到
E时，E会返回一个应答报文给A，所以A最终能收到B的送达确认
（+SEND:sn,SEND OK）和E的送达确认（+ACK:<SRC>,<RSSI>,<SN>），从
而得知数据真实到达了目标节点；
```

### 3 9 .功耗模式......................................................................................................

在本系统中，目前支持四种功耗模式，分别是TypeA，TypeB,TypeC
和TypeD模式。
1 ）TypeC模式是低功耗模式，在TypeC模式下
a. 节点射频休眠时会进入空口侦听状态（可以通过指令配置侦听周
期），其他节点可以通过发送空口唤醒信号唤醒本节点；
b. 节点收到业务数据时，会拉低RI脚，并且在 60 ms后推送业务报文
给上位机；
c. 上位机需要与模组交互时，需要拉高WAKE脚并且等待+READY推送
后再发送AT指令；
2 ）TypeD模式是非低功耗模式，在TypeD模式下
a. 节点射频处于常接收状态；
b. 上位机与模组的交互无需额外的IO动作；
3 ）TypeB模式属于特殊配置模式，在TypeD模式的基础上，凡是广播/组
播报文都不发送唤醒帧；如果配置为TypeB则需要全系统统一配置；
4 ）TypeA模式属于最低功耗模式，每次通信完成后，缺省会维持 120 s的
TypeC工作模式，到期后就不再进行空口侦听，进入深度睡眠，无法被其他节
点唤醒；

##### 在缺省配置下：

##### ·中心节点角色工作在TYPE D模式下；

##### ·普通节点角色工作在TYPE C模式下；

##### 也可以通过AT指令配置具体的工作模式。

### 3 10 .低功耗组网................................................................................................

##### 自组网的网络部署中，会经常出现只有中心节点是市电供电，其余的节点

##### 都是采用电池供电的情况，这个时候就必须要求普通节点在组网过程中采用更

##### 加低的功耗方式；


##### 节点在组网过程中，功耗消耗通常受以下几个因素影响：

##### 1 ）广播转发的深度，即节点转发路由请求的范围，范围越大总体消耗的能

##### 量越多；

##### 2 ）广播转发的密度，即节点发起路由请求的次数，次数越密集总体消耗的

##### 能量越多；

##### 当一个存在中心的树状拓扑内，如果在网络部署时，中心节点没有被布置

##### 到网络中，此时如果下游节点发起路由发现时，只会导致路由发现报文在节点

##### 内盲目转发，导致整个网络造成一波一波的网络风暴，这对于存在低功耗需求

##### 的系统来说是灾难性的。

##### 针对上述场景，本方案设计了一套低功耗的组网策略，即使出现无中心节

##### 点的情况，也不会出现广播风暴，并且当中心节点就绪后，可以有序地以中心

##### 节点为圆心进行逐层建网，并且全程以点播地方式进行，从而进一步降低路由

##### 开销。

### 3 11 .大文件代理传输.........................................................................................

##### 对于物联网应用来说，OTA几乎是一个必选项，不管对于通信模组本身还

##### 是上位机应用都是如此，而通信模组本身具备OTA功能，为了降低上位机应用

##### 的开发难度，模组开放大文件传输通道给上位机，此时上位机只需要把升级包

##### 或者是大的配置包打包通过AT指令传输给中心节点，并且命令中心节点往下

##### 游节点传输即可，中间的拆组包过程由通信协议栈负责，最终下游节点收完大

##### 文件后会通过URC指令告知上位机，上位机只需要通过AT指令就可以从模组

##### 中取出大文件。


##### 中心节点提供以下代理手段：

##### ·提供代理传输文件；

##### ·提供代理查询文件传输结果；

##### ·提供代理查询节点版本；

#### 3 11 1 .文件传输工具功能介绍..................................................................

##### 文件传输工具用于电脑控制中心节点，进行文件的传输和状态查询；也提

##### 供给上位机实现相同功能时的参照步骤；

##### 文件传输工具提供以下功能：

##### ·（组合）本地升级；

##### ·（组合）模组升级；

##### ·（组合）文件传输；

##### ·模拟提取文件；

##### ·各种功能的单步操作；

##### 本文描述组合操作；


### 3. 11. 1. 1 .（组合）本地升级

##### （组合）本地升级包含了以下几个步骤：

##### 1 ）下载升级包到本地；

##### 2 ）执行升级指令；

##### 3 ）校验新版本；

##### 用于通过串口升级连接电脑的模组；

##### 差分包需要满足以下命名规则：

```
X.X.X_Y.Y.Y_TPNNNN.bin
其中
X.X.X表示原版本
Y.Y.Y表示目标版本
NNNN表示板卡类型，比如 TP 1107 /TP 1109 /TP 1107 - MP 30 /TP 1107 -
MP 30 L/TP 1107 - MP 36 /TP 1109 - MP 36
```
### 3. 11. 1. 2 .（组合）模组升级

##### （组合）模组升级包含了以下几个步骤：

(^1) ）下载升级文件到本地；
2 ）执行代理转发文件给其他节点；


##### 3 ）执行代理升级通知；

##### 最大跳数：转发的最大深度，缺省为 0 ，表示由中心节点依据拓扑深度进行

##### 选择；

##### 转发次数:每层的转发次数，缺省为 2 次；

##### 转发模式：每层节点的转发模式， 0 为常规转发模式，即具备转发能力，并

##### 且存在下游节点的节点转发（路由的途径节点转发）； 1 为强制转发模式，即

##### 具备转发能力的节点转发（所有非TYPEA的节点）；缺省为 0 ；

##### 开始跳数：转发的起始层级，缺省为 0 ，表示从中心节点开始往第一层转发，

##### 如果为非 0 值，则由中心节点通知第START_HOP层的节点开始转发；

##### START_HOP必须少于MAX_HOP；

##### 发送次数：代理升级指令发送次数；

##### 在转发过程中，可以点击“进度查询”进行跟踪


### 3. 11. 1. 3 .（组合）文件传输

##### （组合）文件传输包含了以下几个步骤：

##### 1 ）下载升级文件到本地；

##### 2 ）执行代理转发文件给其他节点；

##### 3 ）执行代理提取通知；

##### 过程与（组合）模组升级类似；

### 3. 11. 1. 4 .模拟提取文件

##### 配合（组合）文件传输，可以在电脑端连接另外一个模组，用于体现文件

##### 提取的指令交互过程；

##### 1 ）A模组连接电脑串口COMA，并且使用文件传输工具打开，选择（组合）


##### 文件传输指令；

##### 2 ）B模组连接电脑串口COMB，并且使用文件传输工具打开，选择模拟提取

##### 文件指令；

##### 3 ）A模组执行指令，B模组等待文件提取完成，提取后会把接收到的文件

##### 保存到电脑本地；

##### 上位机可以进入文件提取过程，参照“提取文件数据”指令；

### 3 12 .数据透传模式............................................................................................

##### 本方案推荐使用AT模式(默认模式)进行数据交互，但是也提供透传模式用

##### 于简化对接。

·默认采用AT模式，可以通过AT+EXIT\r\n切换到透传模式；
·透传模式下，可以通过+++\r\n进入AT模式；
·透传方案有四种： 1 ）邻居透传 2 ）隐藏地址定向透传； 3 ）显式地址定向
透传； 4 ）指定地址偏移透传；

#### 3 12 1 .邻居透传.........................................................................................

##### 当模组什么都没有配置，就进入透传模式时，模组采用邻居透传方式传输，

##### ·透传数据只能广播给邻居节点，节点接收到之后不会进行数据转发；


#### 3 12 2 .隐藏地址定向透传.........................................................................

##### ·模组通过AT指令（AT+ADDR）通信地址；

##### ·配置透传模式为隐藏地址定向透传（ 0 ），透传目标地址和数据类型；

##### ·再进入透传模式；后续模组的透传数据就按照透传目标地址发送过去。

##### ·除了数据是通过透传的方式交互外，与AT模式下的协议栈行为一致，可

##### 以使用协议栈提供的路由功能；

##### ·适用于单中心的树状拓扑，非中心节点可以通过AT+TRANS= 0 ,FFFF, 0 来

##### 选择隐藏地址定向透传给中心节点；


#### 3 12 3 .显式地址定向透传.........................................................................

##### ·模组通过AT指令（AT+ADDR）通信地址；

##### ·配置透传模式为显式地址定向透传（ 2 ），透传数据类型；

##### ·再进入透传模式；后续模组的透传数据就需要在前面添加目标地址（ 2 字

##### 节）再透传业务数据，比如业务数据是 1122334455 ，需要发送给 0001 的模组，

##### 最终就传入 00011122334455 。


#### 3 12 4 .指定地址偏移透传.........................................................................

##### ·模组通过AT指令（AT+ADDR）通信地址；

##### ·配置透传模式为显式地址定向透传（ 1 ），地址偏移，透传数据类型；

##### ·再进入透传模式；后续模组的透传数据就会在指定的偏移上获取 2 字节

##### 作为目标地址，比如业务规约为 8 A 050001 AABBCC，其中业务规约的格式为

##### 8 A作为头定义， 05 表示后续有 5 字节， 0001 表示目标地址（业务），

##### AABBCC为业务报文；此时通过配置AT+TRANS= 1 , 2 , 0 表示业务报文的偏移 2

##### 字节为目标地址，协议栈使用UM发送；可以在不增加额外数据的情况下使用

##### 本协议栈进行数据透传；


##### ·通常用于平替原有的通信系统，比如原来电网使用 101 规约走 485 通信，

##### 现在可以在不更改电网终端的情况下，把 485 改为TPMESH模组，只要指定好

##### 规约的地址段偏移值就可以平替原来的通信系统；

### 3 13 .射频测试模式（生产测试）....................................................................

##### 本模块提供了生产测试模式FTM用于简单地进行射频性能测试；

##### 注意的是，如果进入了FTM模式，不能进行正常的业务收发，如果需要返

##### 回正常的业务收发则需要

##### 1 ）执行AT+DEF回复出厂设置（重置原有配置）

##### 2 ）或者AT+TPS=TPMESH切换到TPMESH协议栈（不会修改原有配置）；

#### 3 13 1 .指令简介.........................................................................................

FTM_TX说明
AT+FTM_TX= 3 , 200 , 0 , 0 , 470000 , 76800 , 38400 , 100 , 0 , 0
参数 1 : 固定填 3

参数 2 : 数据长度

参数 3 : 最大发送次数， 0 则一直发送下去


参数 4 : 固定填 0

参数 5 / 6 / 7 :频点，波特率，带宽

参数 8 : 两次发送的间隔ms

参数 9 : 发射功率

参数 10 : 固定填 0

停止发送AT+FTM_TX

FTM_RX详细说明：

AT+FTM_RX= 3 , 200 , 0 , 0 , 470000 , 76800 , 38400 , 100 , 0

参数 1 : 固定填 3

参数 2 : 数据长度

参数 3 : 最大接收次数， 0 则一直接收下去

参数 4 : 固定填 0

参数 5 / 6 / 7 :频点，波特率，带宽

参数 8 : 单次的接收超时时间， 0 则表示一直监听，不会超时
参数 9 : 固定填 0

停止接收AT+FTM_RX

底噪扫描
AT+FTM_NOISE= 1 , 480000 , 76800
参数^1 :^0 ：全频段^1 ：频段^2 ：单点
参数 2 ：频点/段开始
参数 3 ：固定填 76800

AT+FTM_NOISE停止扫描


#### 3 13 2 .测试介绍.........................................................................................

1 ）进入FTM模式（在AT模式下，执行AT+TPS=FTM\r\n）
2 ）准备一对设备（设备A和设备B），A用于发送；B用于接收；
A执行AT+FTM_TX= 3 , 200 , 50 , 0 , 470000 , 76800 , 38400 , 100 , 20 , 0
表示在^470000 频点上，以^100 ms间隔发送^50 包^200 字节的报文，发射功率为
20 dBm；

```
B执行AT+FTM_RX= 3 , 200 , 20 , 0 , 470000 , 76800 , 38400 , 100 , 0
表示在 470000 频点上，以 100 ms间隔侦听 20 包 200 字节的报文；
```
3 ）测试完成后，执行AT+TPS=TPMESH\r\n返回TPMESH协议栈（必须执
行，否则不能正常通信）；

#### 3 13 3 .底噪扫描.........................................................................................

##### 当需要部署时可以使用FTM的底噪扫描功能获取周边的射频环境：

1 ）进入FTM模式（在AT模式下，执行AT+TPS=FTM\r\n）
2 ）执行AT+FTM_NOISE= 0 , 470000 , 76800 \r\n
表示从 470000 间隔 200 k一路扫到 510000 ，每个频点做 100 次采样，间
隔 10 ms，其中我们只要关注MAXNOISE即可


### 3 14 .参考指标....................................................................................................

#### 3 14 1 .时延.................................................................................................

##### 由于串口波特率可配置，所以下面传输耗时的起始点是模组收完串口指令，

##### 结束点是协议栈接收完数据，准备往AT口发送；

##### 由于空口唤醒时间可配置，所以下面传输耗时不包含唤醒时间，如果配置

##### 了唤醒周期需要每跳额外加上唤醒帧发送发送时间；

##### 空口速率 业务报文长度 耗时 网络拓扑

(^768005021) ms@快速发送
40 ms@UM发送

##### 二级一跳

(^7680020040) ms@快速发送
58 ms@UM发送

##### 二级一跳

```
76800 50 80 ms@快速发送
153 ms@UM发送
```
##### 五级四跳


(^76800200153) ms@快速发送
229 ms@UM发送

##### 五级四跳

(^192005045) ms@快速发送
83 ms@UM发送

##### 二级一跳

(^19200200111) ms@快速发送
150 ms@UM发送

##### 二级一跳

(^1920050201) ms@快速发送
358 ms@UM发送

##### 五级四跳

```
19200 200 466 ms@快速发送
618 ms@UM发送
```
##### 五级四跳

#### 3 14 2 .待机功耗.........................................................................................

```
空口速率 唤醒周期（ms） 平均待机功耗（uA）
19200 200 223
19200 500 90
19200 1000 46
19200 2000 24
76800 200 127
76800 500 44
76800 1000 21
76800 2000 12
```
#### 3 14 3 .发送功耗.........................................................................................

```
发送功率（dBm） 功耗峰值（mA）
20 116
17 68
10 35
0 21
```

## 1 .AT指令详细描述.................................................................................

### 1 1 .AT接口配置.................................................................................................

```
模组出厂默认配置为 115200 bps, 8 N 1 。
8 :表示 8 位数据位;
N:表示无校验;
1 :表示 1 位停止位。
```
### 1 2 .AT指令.........................................................................................................

##### 传感采集终端模组和上位机之间的软件通信通过AT指令集实现。AT指令

集是一种应用于AT服务器(ATServer)与AT客户端(ATClient)间的设备连接与
数据通信的方式。一般AT指令由三个部分组成，分别是:前缀、主体和结束符。
其中前缀由字符AT构成；主体由命令、参数和可能用到的数据组成；结束符
一般为("\r\n")。“AT”两个字符,总是用来启动从TE(上位机ATClient)发送到TA
(模组ATServer)的命令行^1 。AT数据分为AT请求命令数据，请求命令的响应数
据+结果，URC数据。URC数据为非请求结果码（UnsolicitedResultCode），
特指ATServer主动发送给ATClient的数据。一般在特殊情况才会发送，比如
无线连接断开、通知传感器上位机接收数据等，具有一定的随机性。

### 1 3 .命令格式......................................................................................................

##### 命令使用ASCII码字符串，有 3 种格式，分别如下:

##### 执行格式 AT+<CMD><CR><LF>

(^1) 定义来自< 3 GPPTS 07. 07 V 7. 8. 0 ( 2003 - 03 )>


##### 查询格式 AT+<CMD>?<CR><LF>

配置格式 AT+<CMD>=<参数 1 >[,参数 2 ]...[,参数n]<CR><LF>

说明:
1. 命令以"AT+"开头,<CR><LF>（回车换行符, 16 进制值为 0 x 0 D 0 x 0 A，即
"\r\n"，下文相同）结尾；
2. <>:表示必须包含的部分；
3. []:表示可选的部分;
4. 命令参数不区分大小写；
5. 输入参数不能出现连续两个或多个逗号；
6. AT指令执行返回的结果前都添加指令内容(如+<CMD>:)，后续的格式说明中
不再显式描述，可参考具体示例。
命令执行的返回主要有以下几种类型:
返回格式 描述
+<CMD>:"OK"<CR><LF> 表示成功，多见于执行和配置类命令的返
回
+<CMD>:"ERROR"<CR><LF> 表示失败，多见于执行和配置类命令的返
回
+<CMD>:"ERROR, 1 "<CR><LF> 表示输入的指令无法识别
+<CMD>:"ERROR, 2 "<CR><LF> 表示能够识别指令，但输入参数无效，多
见于配置类命令的返回
+<CMD>:"ERROR, 3 "<CR><LF> 表示未配置地址

### 1 4 .命令分类说明..............................................................................................

##### 模组AT命令集分为以下几类: 通用指令，通信指令，URC指示。URC指示为模

##### 组主动发出，通用指令和通信指令为上位机发送给模组的AT指令。

### 1 5 .通用指令......................................................................................................

#### 1 5 1 AT...................................................................................................

##### 描述 测试串口通信正常

```
格式 AT\r\n
返回 OK\r\n
```

##### 参数 无

##### 备注 无

##### 示例

```
发送:AT\r\n
返回:+AT:OK\r\n
```
#### 1 5 2 配置AT串口UART........................................................................

##### 描述 配置AT串口参数

```
格式 AT+UART=<BAUD>,<DATA>,<STOP>,<PARITY>,<FLOW>,<ADDCHK>\r\n
```
```
返回 成功：OK\r\n
失败：ERROR\r\n或ERROR, 2 \r\n，参见 2. 1
```
##### 参数

##### BAUD：串口波特率；

##### 支持波特率 1200 / 2400 / 4800 / 9600 / 19200 / 38400 /

##### 57600 / 115200 / 230400 / 460800 / 1000000

```
DATA：数据位数， 8 表示 8 bit数据，其他保留；
STOP：停止位， 1 表示 1 个停止位，其他保留；
PARITY：校验， 0 表示不校验， 1 表示ODD奇校验， 2 表示EVEN
偶校验，其他保留 ；
FLOW:流控， 0 表示无流控，其他保留；
ADDCHK:前面所有参数之和；
```
```
备注
```
##### 对指令的回复在原始的配置下返回

```
默认 115200 bps, 8 N 1
```
```
示例
```
```
发送:AT+UART= 115200 , 8 , 1 , 0 , 0 , 115209 \r\n
返回:+UART:OK\r\n
```
#### 1 5 3 查询AT串口UART........................................................................

##### 描述 查询AT串口参数

```
格式 AT+UART?\r\n
```
```
返回
```
```
成功：<BAUD>,<DATA>,<STOP>,<PARITY>,<FLOW>\r\nOK\r\n
失败：ERROR\r\n，参见 2. 1
```

##### 参数 参数描述参考 2. 3. 8

##### 备注

##### 示例

```
发送:AT+UART?\r\n
```
```
返回:+UART: 9600 , 8 , 1 , 0 , 0 \r\nOK\r\n
```
#### 1 5 4 查询固件版本VER........................................................................

##### 描述 查询固件版本

```
格式 AT+VER?\r\n
返回 [版本号]_[分支]_[哈希值]_[型号]\r\nOK\r\n
参数 无
备注 无
```
```
示例
```
```
发送:AT+VER?\r\n
返回:+VER:V 1. 2. 3 _master_ 12345678 _TP 1107 \r\nOK\r\n
```
#### 1 5 5 进入AT模式+++...........................................................................

##### 描述 进入AT模式

```
格式 +++\r\n
返回 成功:OK\r\n
参数 无
```
##### 备注

```
指令属于严格匹配（注意不要多空行或者多\r\n）
从透传模式进入AT模式
默认AT模式
```
```
示例
```
```
发送:+++\r\n
返回:OK\r\n
```
#### 1 5 6 软重启REBOOT..............................................................................

##### 描述 重启模组

```
格式 AT+REBOOT\r\n
```

```
返回 成功:OK\r\n
参数 无
备注 返回OK，然后系统自动重启
```
```
示例
```
```
发送:AT+REBOOT\r\n
返回:+REBOOT:OK\r\n
```
#### 1 5 7 查询ESN........................................................................................

##### 描述 查询模组ESN

```
格式 AT+ESN?\r\n
返回 成功:+ESN:[ESN]\r\nOK\r\n
参数 无
备注 如果没有配置返回ERROR
```
```
示例
```
```
发送:AT+ESN\r\n
返回:+ESN:FF 0000000001 \r\nOK\r\n
```
#### 1 5 8 进入透传模式EXIT......................................................................

##### 描述 进入透传模式

```
格式 AT+EXIT\r\n
返回 成功:OK\r\n
参数 无
```
```
备注
```
##### 从AT模式进入透传模式，具体的透传模式依据AT+TRANS指令配

##### 置的模式。

```
示例 发送:AT+EXIT\r\n
返回:OK\r\n
```
### 1 6 配置指令...................................................................................................

#### 1 6 1 .配置通信地址ADDR.......................................................................

##### 描述 配置通信地址


```
格式 AT+ADDR=<addr>[,<group_addr>]\r\n
```
```
返回
```
##### 参数错误返回ERROR 2

##### 执行成功返回OK

##### 参数

```
<addr> : 通信地址（Hex, 2 Byte）,
常规模式下：
中心节点范围[ 0 xFFBE, 0 xFFFE];
普通节点范围[ 1 , 0 xFEFF]；
纯Mesh模式下：
节点范围[ 0 xFFBE, 0 xFFFE]或者[ 1 , 0 xFEFF]；
[group_addr]: 组播地址（Hex, 2 Byte），
范围[ 0 xFF 7 D, 0 xFFBD]
```
##### 备注

##### 配置完成后会自动重启；

```
如果没有配置通信地址，则上电后会维持 1 min后休眠，如果此
后需要配置AT指令需要拉高WAKE脚；
```
```
示例
```
```
发送:AT+ADDR= 0001 ,ffaa\r\n
返回:+ADDR:OK\r\n
```
#### 1 6 2 .查询通信地址ADDR.......................................................................

##### 描述 查询通信地址

```
格式 AT+ADDR?\r\n
```
```
返回
```
##### 参数错误返回ERROR 2

##### 执行成功返回OK

##### 参数

```
ROOT[是否中心节点]\n
ADDR[点播地址]\n
GROUP_ADDR[组播地址]\n
备注 ROOT表示是否为中心节点， 1 为是 0 为不是；
```
```
示例
```
```
发送:AT+ADDR?\r\n
返回:+ADDR:
```

```
ROOT[ 1 ]\r\n
ADDR[ 0 x 0001 ]\r\n
GROUP_ADDR[ 0 xFFAA]\r\n
OK\r\n
```
#### 1 6 3 .配置小区ID......................................................................................

##### 描述 配置小区ID

```
格式 AT+CELL=<value>\r\n
```
```
返回 参数错误返回ERROR^2
执行成功返回OK
参数 <value> : 小区ID值范围[ 0 , 255 ]
```
##### 备注

##### 执行成功后重启；

##### 如果多个小区存在信号重叠的场景，建议相邻小区号相差不小于

##### 16 ；

##### 默认 0 ；

##### 示例

```
发送:AT+CELL= 20 \r\n
返回:+CELL:OK\r\n
```
#### 1 6 4 .查询小区ID......................................................................................

##### 描述 查询小区ID

```
格式 AT+CELL?\r\n
```
```
返回
```
##### 参数错误返回ERROR 2

##### 执行成功返回OK

```
参数 [小区ID]\n
备注
```
##### 示例

```
发送:AT+CELL?\r\n
返回:+CELL: 0 \r\n
OK\r\n
```

#### 1 6 5 .配置唤醒周期WOR.........................................................................

##### 描述 配置唤醒周期

```
格式 AT+WOR=<period>\r\n
```
```
返回 参数错误返回ERROR^2
执行成功返回OK
```
```
参数
```
```
<period> : 唤醒周期，可选值
100 / 200 / 300 / 500 / 1000 / 2000 / 3000 单位ms
```
```
备注 配置完成后会自动重启；
默认 200 ms
```
```
示例
```
```
发送:AT+WOR= 200 \r\n
返回:+WOR:OK\r\n
```
#### 1 6 6 .查询唤醒周期WOR.........................................................................

##### 描述 查询唤醒周期

```
格式 AT+WOR?\r\n
```
```
返回
```
##### 参数错误返回ERROR 2

##### 执行成功返回OK

```
参数 [period] 单位ms
备注
```
##### 示例

```
发送:AT+WOR?\r\n
返回:+WOR: 1000 \r\n
OK\r\n
```
#### 1 6 7 .配置功耗模式LP..............................................................................

##### 描述 配置功耗模式

```
格式 AT+LP=<value>\r\n
返回 参数错误返回ERROR 2
```

##### 执行成功返回OK

##### 参数

```
<value> : 0 表示Type A; 1 表示Type B; 2 表示TYPE C； 3 表示
TYPE D
```
##### 备注

##### 配置成功后会重启

```
中心节点默认Type D;
普通节点默认Type C;
如果配置为Type B，则需要全网节点都为非低功耗节点（Type
B 或者Type D）
```
```
示例
```
```
发送:AT+LP= 3 \r\n
返回:+LP:OK\r\n
```
#### 1 6 8 .查询功耗模式LP..............................................................................

##### 描述 查询功耗模式

```
格式 AT+LP?\r\n
```
```
返回
```
##### 参数错误返回ERROR 2

##### 执行成功返回OK

```
参数 [功耗模式]\n
备注
```
##### 示例

```
发送:AT+LP?\r\n
返回:+LP: 3 \r\n
OK\r\n
```
#### 1 6 9 .配置透传参数TRANS.....................................................................

##### 描述 配置透传参数

```
格式 AT+TRANS=<MODE>,<VAL 1 >[,<VAL 2 >]\r\n
```
```
返回 参数错误返回ERROR^2
执行成功返回OK
参数 <MODE> 表示透传模式， 0 为隐藏地址定向透传； 1 为指定地址偏
```

##### 移透传； 2 为显式地址定向透传；

##### 当MODE为 0 时，VAL 1 和VAL 2 生效

```
VAL 1 表示接收数据的目标地址（Hex, 2 Byte），参照SEND
指令；
VAL 2 表示消息类型，参照SEND指令
```
```
当MODE为 1 时，VAL 1 和VAL 2 生效
VAL 1 表示接收数据的目标地址的偏移字节数，Dec；
VAL 2 表示消息类型，参照SEND指令
```
##### 当MODE为 2 时，VAL 1 生效

##### VAL 1 表示消息类型，参照SEND指令

##### 备注

##### 在AT模式下配置透传参数，进入透传模式时按照参数指定地址

##### 和类型发送

##### 默认MODE为 0 ，TYPE为 0 ，当为中心节点时，ADDR为 0000 ；当

##### 为普通节点时，ADDR为FFFF

##### 示例

```
发送:AT+TRANS= 0 ,FFFF, 0 \r\n
返回:+TRANS:OK\r\n
其他例子参照“数据透传模式”章节
```
#### 1 6 10 .查询透传参数TRANS...................................................................

##### 描述 查询透传参数

```
格式 AT+TRANS?\r\n
```
##### 返回

```
ENABLE:是否开启透传模式， 1 为透传， 0 为AT模式\r\n
MODE：透传模式类型， 0 为隐藏地址定向透传， 1 为指定地址偏
移定向透传； 2 为显式地址定向透传；
ADDR:透传数据的目标地址\r\n
```

```
TYPE:透传数据的类型\r\n
ADDR_POS:指定地址偏移字节量\r\n
OK\r\n
参数
备注
```
##### 示例

```
发送:AT+TRANS?\r\n
返回:+TRANS:ENABLE[ 0 ]\r\n
MODE:[ 0 ]\r\n
ADDR[ 0 xFFFF]\r\n
TYPE[ 0 ]\r\n
ADDR_POS[ 0 ]\r\n
OK\r\n
```
#### 1 6 11 .配置私有会话KEY........................................................................

##### 描述

##### 配置私有会话KEY，用于区分配置了相同CELL但是不同应用/厂

##### 家的场景

```
格式 AT+KEY=<value>\r\n
```
```
返回
```
##### 参数错误返回ERROR 2

##### 执行成功返回OK

```
参数 <value> : 表示私有的会话密钥，范围[ 0 , 255 ]
```
##### 备注

##### 配置成功后会重启

##### 默认为 0 ，即没有私有会话密钥，此时只要相同的CELL配置就

##### 可以相互通信；

##### 当配置了KEY之后，一整个应用切片就必须要配置相同的KEY才

##### 可以通信；

##### 示例

```
发送:AT+KEY= 3 \r\n
返回:+KEY:OK\r\n
```

#### 1 6 12 .查询私有会话KEY........................................................................

##### 描述 查询私有会话KEY

```
格式 AT+KEY?\r\n
```
```
返回
```
##### 参数错误返回ERROR 2

##### 执行成功返回OK

```
参数 [KEY]\n
备注
```
##### 示例

```
发送:AT+KEY?\r\n
返回:+KEY: 3 \r\n
OK\r\n
```
## 1 7 .通信指令......................................................................................................

### 1 7 1 数据发送SEND..............................................................................

##### 描述 数据发送

```
格式 AT+SEND=<ADDR>,<LEN>,<DATA>,<TYPE>\r\n
```
```
返回
```
```
参数校验成功:OK\r\n
无效参数:ERROR, 2 \r\n
```
##### 参数

```
ADDR:接收数据的目标地址（Hex, 2 Byte）
LEN:需要发送数据的长度（Dec），范围[ 1 , 200 ]
DATA:需要发送的数据(Hex)
TYPE:消息类型
0 :UM,发送数据无需接收者送达确认；
1 :AM,发送数据需要接收者送达确认；
2 :FAST,减少握手次数快速发送（无需接收者送达确认）；
3 :FLOOD,泛洪发送；
```
```
备注^1 ）普通节点如果需要向中心节点发送数据但是不知道中心节点
的具体地址，可以在ADDR中填FFFF表示任意中心节点；
```

##### 2 ）如果是AM类型，目标地址不能是广播、组播地址；

##### 3 ）如果是FAST类型，目标地址不能是广播、组播地址；

##### 4 ）发送过程使用URC异步输出，参考 1. 8. 8 ；

##### 5 ）如果自身没有配置有效地址，则会返回ERROR, 3

##### 示例

```
发送:AT+SEND=FFFF, 5 , 0123456789 , 0 \r\n
返回:+SEND:OK\r\n
完整样例参考 1. 8. 8
```
## 1 8 .URC指示.....................................................................................................

### 1 8 1 模组完成重启...............................................................................

##### 描述 完成重启

```
格式 +BOOT\r\n
返回 N/A
参数
备注 模组完成重启后时输出
示例
```
### 1 8 2 模组AT接口就绪.........................................................................

##### 描述 AT接口就绪

```
格式 +READY\r\n
返回 N/A
参数
备注 可以开始接收AT指令
示例
```
### 1 8 3 路由创建.......................................................................................

##### 描述 新节点路由创建指示

```
格式 +ROUTE:CREATE ADDR[节点地址]\r\n
返回 N/A
```

##### 参数

##### 备注 新节点路由创建时输出

```
示例 +ROUTE:CREATE ADDR[ 0 xFFFE]\r\n
```
### 1 8 4 路由删除.......................................................................................

##### 描述 节点路由删除指示

```
格式 +ROUTE:DELETE ADDR[节点地址]\r\n
返回 N/A
参数
备注 节点路由删除时输出
示例 +ROUTE:DELETE ADDR[ 0 xFFFE]\r\n
```
### 1 8 5 模组进入休眠...............................................................................

##### 描述 模组进入休眠

```
格式 +SUSPEND\r\n
返回 N/A
参数
备注 模组进入休眠时输出
示例
```
### 1 8 6 模组退出休眠...............................................................................

##### 描述 模组退出休眠

```
格式 +RESUME\r\n
返回 N/A
参数
备注 模组退出休眠时输出
示例
```
### 1 8 7 数据接收.......................................................................................

##### 描述 接收数据


```
格式 +NNMI:<SRC>,<DEST>,<RSSI>,<LEN>,<DATA>\r\n
返回 N/A
```
##### 参数

```
SRC:数据源地址（Hex, 2 Byte）
DEST:数据的目标地址（Hex, 2 Byte）
RSSI:综合链路RSSI，范围[- 127 ,- 1 ]
LEN:接收数据的长度（Dec）
DATA:接收的数据(Hex, Ascii)
```
##### 备注

##### 模组接收到数据时输出

##### DEST为 0000 时表示广播接收

##### DEST为组播地址时表示组播接收

##### DEST为自己地址时表示点播接收

```
示例 +NNMI:FFFE, 0001 ,- 80 , 10 , 00112233445566778899 \r\n
```
### 1 8 8 数据发送过程...............................................................................

##### 描述

##### 在发送数据期间，存在若干个阶段或者执行结果，通过该指示输

##### 出。

```
格式 +SEND:<SN>,<RESULT>\r\n
返回 N/A
```
##### 参数

##### SN: 模组在接收发送报文时，为其分配一个需要用于跟踪后续的

##### 发送状态变更， 0 表示异常指示，[ 1 , 63 ]循环使用；

##### RESULT:发送阶段，参考以下描述

##### HANDLE OK:成功添加到发送队列；

##### HANDLE ERROR:添加到发送队列失败(队列已满);

##### PREPARE:开始执行发送；

##### SEND OK:送达成功；

##### SEND ERROR:超时未能送达；

##### JOINING: 正在建立路由；

##### ROUTE FULL：路由已满；


##### BUSY：表示目前正在OTA过程；

```
备注 当遇到BUSY返回时，建议等待 10 min后再尝试；
```
##### 示例

```
发送:AT+SEND=FFFF, 5 , 0123456789 , 0 \r\n
立即返回:+SEND:OK\r\n
```
##### URC阶段：

##### 成功示例：

```
+SEND: 10 ,HANDLE OK\r\n
+SEND: 10 ,PREPARE\r\n
+SEND: 10 ,SEND OK\r\n
```
##### 失败示例 1 （发送超时）：

```
+SEND: 10 ,HANDLE OK\r\n
+SEND: 10 ,PREPARE\r\n
+SEND: 10 ,SEND ERROR\r\n
```
```
失败示例 2 （队列已满）：
+SEND: 0 ,HANDLE ERROR\r\n
```
```
失败示例 3 （路由建立中）：
+SEND: 0 ,JOINING\r\n
```
### 1 8 9 送达确认.......................................................................................

##### 描述 收到送达确认指示

```
格式 +ACK:<SRC>,<RSSI>,<SN>\r\n
返回 N/A
参数 SRC表示送达确认的发送方
```

##### RSSI表示综合链路RSSI

##### SN表示SEND指令返回的SN序号

##### 备注 收到送达确认时输出

```
示例 +ACK:FFFE,- 80 , 10 \r\n
```
### 1 8 10 泛洪数据接收.............................................................................

##### 描述 泛洪数据接收

```
格式 +FLOOD:<SRC>,<LEN>,<DATA>\r\n
返回 N/A
```
##### 参数

```
SRC:数据源地址（Hex, 2 Byte）
LEN:接收数据的长度（Dec）
DATA:接收的数据(Hex, Ascii)
备注 收到泛洪数据时输出
示例 +FLOOD: 0001 , 10 , 00112233445566778899 \r\n
```
## 1 9 .运维指令......................................................................................................

### 1 9 1 .查询邻居信息NB.............................................................................

##### 描述 查询邻居信息

```
格式 AT+DUMP=NB[,<START>,<CNT>]\r\n
```
##### 返回

```
slotMap[ 0010 ] totSlotMap[ 03 ff] unicast_slot[ 0 ]
addr[ 0 xffca]le[ 1 ]rx/tx_slot[ 4 : 6 ]tim_sn[ 0 ]rx_sn[ 0 ]
loc/rmot_rssi[- 73 : 71 ]nb_num[ 1 ]life[ 86392 ]os_tick[ 0 / 65 ]
OK\r\n
```
##### 参数

##### 作为内部指令，此处只解析一般关心的参数：

```
addr表示邻居的地址；
le 表示邻居的功耗类型， 1 表示Type B; 2 表示TYPE C； 3 表示
TYPE D
```

```
loc 表示本节点收到addr的rssi；
rmote_rssi 表示addr收到本节点的rssi;
```
```
备注
```
##### 当START和CNT都填非 0 时，表示从第START个项（含）开始，

##### 最多打印CNT个邻居项；

##### 示例

### 1 9 2 .查询路由信息RT..............................................................................

##### 描述 查询路由信息

```
格式 AT+DUMP=RT[,<START>,<CNT>]\r\n
```
```
返回
```
```
ADDR[ 0 xFFCA]IDX[ 0 ]HOP[ 1 ]RSSI[- 73 ]VAL[ 83. 00 ]TYPE[ 0 ]ERR[ 0 ]LT[ 170156 ]PATH[]
ADDR[ 0 xAAAA]IDX[ 0 ]HOP[ 3 ]RSSI[- 1 ]VAL[ 184. 00 ]TYPE[ 2 ]ERR[ 0 ]LT[ 172790 ]
PATH[CCCC-BBBB]
```
##### 参数

##### 作为内部指令，此处只解析一般关心的参数：

##### ADDR 表示目标节点地址；

##### IDX 表示多路径时的路由路径序号，其中 0 表示最高优先级；

##### HOP 表示跳数；

```
RSSI 表示整个路由路径的空口链路的加权rssi；
VAL 表示路径的综合分数，分数高表示权重高；
TYPE 表示路径的创建类型， 0 表示路由发现， 1 表示空口修正；
2 表示静态添加；
ERR 表示路径的连续错误次数；
LT 表示路径的老化时间；
PATH 表示途径节点的顺序，比如CCCC-BBBB表示本节点需要经
过CCCC-BBBB才到AAAA；
```
```
备注 当START和CNT都填非^0 时，表示从第START个项（含）开始，
最多打印CNT个路由项；
示例
```

### 1 9 3 .查询OTA状态..................................................................................

##### 描述 查询OTA状态，用于代理文件状态查询期间跟踪当前信息

```
格式 AT+DUMP=OTA\r\n
```
##### 返回

```
PROXY_STATUS[DONE]FW_CNT[ 0 ]FW_MODE[ 0 ]CHUNK_CNT[ 0 ]
MAX_HOP[ 1 ]CUR_HOP[ 2 ]MAX_GRP[ 1 ]CUR_GRP[ 0 ]AGAIN[ 1 ]
MD 5 [B 11 C 756727 C 663 F 3428 D 7 C 5041806 C 71 ]
VER[ 0. 0. 0 ]DEVTYPE[ 0 ]
ADDR[ 0 x 0001 ]HOP[ 1 ]STATE[SAME]
```
##### 参数

##### PROXY_STATUS 表示当前的查询状态；

##### FW_CNT 表示转发次数，仅用于文件代理转发；

##### FW_MODE 表示文件转发模式，仅用于文件代理转发；

##### CHUNK_CNT 表示分片总数，仅用于文件代理转发；

##### MAX_HOP 表示拓扑最大深度；

##### CUR_HOP 表示当前正在执行的深度；

##### MAX_GRP 表示分组查询的最大分组，仅用于文件代理查询；

##### CUR_GRP 表示当前查询分组，仅用于文件代理查询；

##### AGAIN 表示当前是否为重复查询，仅用于文件代理查询；

##### MD 5 表示待传输/查询的文件MD 5 ；

##### VER 表示待查询的版本信息，仅用于版本代理查询；

##### DEVTYPE 表示待查询的板卡信息，仅用于版本代理查询；

##### ADDR 表示节点地址；

##### HOP 表示节点深度；

##### STATE 表示与待比较的文件MD 5 /版本信息是否一致，存在三种状

##### 态，N/A 表示未知，SAME表示一致，DIFF表示不一致；

##### 备注

##### 示例

### 1 9 4 .添加静态路由ADDRT.....................................................................

##### 描述 添加静态路由

```
格式 AT+CONFIG=ADDRT,<DEST>[,<PATH>]\r\n
```

##### 返回

##### 参数

##### DEST 表示需要添加的目标地址；

##### PATH 作为可选项，表示从目标地址到本节点的途径节点；如果

##### 不填则表示一跳可达DEST；

##### 备注

##### 静态路由会以最高优先级呈现；

##### AT+CONFIG=ADDRT,AAAA,BBBBCCCC

##### 表示本节点添加AAAA的路由信息；

##### 本节点如果要发数据给AAAA，则需要经过CCCC BBBB；

##### 查询路由信息如下：

```
ADDR[ 0 xAAAA]IDX[ 0 ]HOP[ 3 ]RSSI[- 1 ]VAL[ 184. 00 ]TYPE[ 2 ]ERR[ 0 ]LT[ 172790 ]
PATH[CCCC-BBBB]
示例
```
```
发送:AT+CONFIG=ADDRT,AAAA,BBBBCCCC\r\n
返回:+CONFIG:OK\r\n
```
### 1 9 5 .删除路由DELRT..............................................................................

##### 描述 删除路由

```
格式 AT+CONFIG=DELRT,<DEST>\r\n
返回
参数 DEST 表示需要删除的目标节点地址；会移除所有路径；
备注
```
```
示例 发送:AT+CONFIG=DELRT,AAAA\r\n
返回:+CONFIG:OK\r\n
```
### 1 9 6 .更新邻居信息NB.............................................................................

##### 描述 更新邻居（一跳范围）信息，每次都会刷新

```
格式 AT+NB\r\n
```
##### 返回

##### 参数错误返回ERROR 2

##### 没配置地址返回ERROR

##### 正在发送过程中或者邻居发现过程中返回ERROR


##### 执行成功返回OK

##### 参数 无

##### 备注

```
邻居刷新过程会持续约 3 秒，建议在执行AT+NB后等待 3 s再执
行查询指令，获取最全的邻居信息；
```
```
示例 发送:AT+NB\r\n
返回:+NB:OK\r\n
```
### 1 9 7 .查询邻居信息（简短版）NB..........................................................

##### 描述 查询邻居信息，只呈现最简版本

```
格式 AT+NB?\r\n
返回 执行成功返回OK
```
```
参数 [邻居地址（HEX）,自己收到邻居的RSSI,邻居收到自己的
RSSI]\r\n
备注 存在多个邻居就会以参数描述的组合呈现
```
##### 示例

```
发送:AT+NB?\r\n
返回:+NB:[BBF 2 ,- 71 ,- 72 ]\r\n
[BBF 3 ,- 65 ,- 63 ]\r\n
[BBF 4 ,- 65 ,- 65 ]\r\n
OK\r\n
```
### 1 9 8 .链路PINGPONG.............................................................................

##### 描述 查询一整条链路的节点以及信号情况

```
格式 AT+PIPO=<DEST>\r\n
```
##### 返回

##### 参数错误返回ERROR 2

##### 没目标地址路由返回ERROR

##### 执行成功返回OK

##### 参数

##### <DEST> : 目标地址（HEX），只能是合法的并且已存在路由关系

##### 的点播地址；


##### 备注

##### 执行后需要等待目标地址的返回信息；如果一直没有返回，则表

##### 示链路不通；

##### 示例

```
发送:AT+PIPO=FFFE\r\n
返回:+PIPO:OK\r\n
等待一段时间后，收到URC推送：
+PIPO:\r\n
PING:ME->[FFCC,- 63 ]->[FFCA,- 106 ]->[FFFE,- 93 ]\r\n
PONG:DEST[FFFE]->[FFCA,- 93 ]->[FFCC,- 106 ]->[ME,- 63 ]\r\n
表示从本节点，PING给FFFE节点，经过FFCC(接收rssi为-
63 ),FFCA(接收rssi为- 106 )，最后FFFE节点接收rssi为- 93 ;
从目标节点FFFE返回PONG指令给本节点，经过FFCA(接收rssi
为- 93 ),FFCC(接收rssi为- 106 )，最后到本节点接收rssi为- 63
```
## 1 10 .文件传输....................................................................................................

### 1 10 1 文件提取通知FILE....................................................................

##### 描述 URC消息，模组主动向上位机推送文件提取通知

```
格式 +FILE: 20 ,<TOTALLEN>,<FCRC 16 >,<CRC 16 >\r\n
返回 N/A
```
##### 参数

##### 20 ：命令码（十六进制字符串格式）

##### TOTALLEN：已接收文件总大小，范围[ 0 ，UINT 32 ]（十进制字符

##### 串格式）

##### FCRC 16 ：文件总检验（十六进制字符串格式），高字节先输出；

##### CRC 16 ：计算TOTALLEN到FCRC 16 字段的检验和（十六进制字符

##### 串格式），高字节先输出。

##### 备注

##### 若上位机接收到CRC 16 错误，则不需要回复此通知，等待模组重

##### 发；


##### 若超时并达到最大重传次数，则解除文件锁定，拒绝提取；

FCRC 16 、 CRC 16 生成 多 项 式 CRC 16 - Modbus （ 0 x 8005 ）
x 16 +x 15 +x 2 + 1 。

FCRC 16 的计算方式参照以下代码：
staticvoidhost_crc 16 _cycle(uint 16 _t*crc,uint 8 _t*data,uint 16 _t
length)
{
uint 16 _tt_crc=*crc;
uint 16 _ti,j;
for(i= 0 ;i<length;i++){
t_crc^=data[i];
for(j= 0 ;j< 8 ;j++){
if(t_crc& 0 x 0001 ){
t_crc=(t_crc>> 1 )^ 0 xA 001 ;
}else{
t_crc=(t_crc>> 1 );
}
}
}
*crc=t_crc;
}
staticuint 16 _thost_crc 16 _calc_from_flash(constuint 32 _taddr,
uint 16 _tlength)
{
uint 32 _trFlashAddr=addr;
uint 8 _tuintBuff[CRC 16 _HANDLE_UNIT]={ 0 };
uint 32 _tunitNum=length/CRC 16 _HANDLE_UNIT;
uint 32 _tremainder=length%CRC 16 _HANDLE_UNIT;
uint 16 _tcrc= 0 xFFFF;
uint 16 _ti;
flash_dev=device_get_binding(CONFIG_FOTA_FLASH_DEVICE_NAME);
if(flash_dev==NULL){
return 1 ;
}
for(i= 0 ;i<unitNum;i++){
flash_read(flash_dev,rFlashAddr,uintBuff,
CRC 16 _HANDLE_UNIT);
host_crc 16 _cycle(&crc,uintBuff,CRC 16 _HANDLE_UNIT);
rFlashAddr+=CRC 16 _HANDLE_UNIT;
}
if(remainder!= 0 ){
flash_read(flash_dev,rFlashAddr,uintBuff,remainder);
host_crc 16 _cycle(&crc,uintBuff,remainder);


```
}
returncrc;
}
```
##### 示例

```
发送:+FILE: 20 , 151008 ,E 0 C 3 ,D 066 \r\n
CRC 16 计算，数据前 4 个字节为TOTALLEN的UINT 32 的十六进制
数： 00024 DE 0 E 0 C 3
```
### 1 10 2 .提取通知回复.................................................................................

##### 描述 上位机向模组回复文件提取确认

```
格式 AT+FOPS= 20 ,<CODE>\r\n
```
##### 返回

```
成功：+FOPS: 20 ,OK\r\n
失败：ERROR\r\n或ERROR, 2 \r\n
若当前状态下命令不可用，则返回+FOPS: 20 ,ERR 0 \r\n
```
##### 参数

##### 20 ：命令码（十六进制字符串格式）

##### CODE：状态码（十进制字符串格式）

##### 0 ：确认提取；

##### 1 ：放弃提取；

##### 备注

##### 上位机可根据下载请求判断是否允许接收文件；

##### 若提取确认，则 5 分钟内不再发送提取通知；

##### 示例

```
发送:AT+FOPS= 20 , 0 \r\n
返回:+FOPS: 20 ,OK\r\n
```
### 1 10 3 .提取文件数据.................................................................................

##### 描述 上位机向模组请求文件数据提取

```
格式 AT+FOPS= 30 ,<OFFSET>,<LEN>\r\n
```
##### 返回

```
成功：+FOPS: 30 ,<OFFSET>,<LEN>,<DATA>,<CRC 16 >\r\nOK\r\n
失败：ERROR\r\n或ERROR, 2 \r\n
提取参数错误（OFFSET+LEN大于文件TOTALLEN）会按照参数错
```

##### 误回复；

```
若当前状态下命令不可用，则返回+FOPS: 30 ,ERR 0 \r\n
```
##### 参数

##### 30 ：命令码（十六进制字符串格式）

##### OFFSET：本次请求传输相对整个文件数据起点的偏移，返回时与本次

##### 请求一致（十六进制字符串格式）

##### LEN：本次请求数据长度，返回时与本次请求一致（十进制字符串格

##### 式），范围[ 1 ， 1024 ]

##### DATA：本包数据，单位字节（十六进制字符串格式）

```
CRC 16 ：本包的数据的CRC 16 校验值，仅计算DATA字段的检验和
（十六进制字符串格式），高字节先输出。
```
```
备注
```
##### 上位机分包提取文件数据；

```
CRC 16 生成多项式CRC 16 - Modbus（ 0 x 8005 ） x 16 +x 15 +x 2 + 1 。
```
```
示例
```
```
发送:AT+FOPS= 30 , 2 A, 5 \r\n
返回:+FOPS: 30 , 2 A, 5 , 2 BC 058 D 215 ,BA 20 \r\nOK\r\n
```
### 1 10 4 .OTA本地交互NOTA.....................................................................

##### 描述 配置透传参数

```
格式 AT+NOTA=<LEN>,<DATA>\r\n
```
```
返回 参数错误返回ERROR^2
执行成功返回OK
```
```
参数
```
```
<LEN> 需要发送数据的长度（Dec）
<DATA> NOTA指令格式
```
```
备注 参照《NOTA相关指令》
提供文件下载，文件状态查询，文件转发，执行升级等功能；
```
##### 示例

##### 查询本地文件MD 5

```
发送：AT+NOTA= 7 , 8 AC 00001004 F 80 \r\n
返回：
+NOTA: 23 , 8 AC 0001100 F 4 B 4499 AF 5 B 826 DBDDCF 7 B 626 E 6 D 4 E 2 E 9 F 0 D\r\n
```

```
OK\r\n
```
### 1. 10. 4. 1 .NOTA流程

##### 详细过程可以参照《TPMESH文件传输工具》的操作细节，本章只描述大

##### 概过程；

**1. 10. 4. 1. 1.** 模组自己升级

```
1 ）执行 8 AD 1 请求下载；
2 ）执行 8 AD 2 分片下载文件；
3 ）执行 8 AD 4 执行升级，注意需要填充正确的板卡类型；
```
**1. 10. 4. 1. 2.** 升级其他模组

```
1 ）执行 8 AD 1 请求下载；
2 ）执行 8 AD 2 分片下载文件；
```

3 ）执行 8 AC 1 让模组代理转发文件，直到收到+NOTA_URC:PROXY_DONE表示模组代
理转发结束；

4 ）如果需要查询文件的下载情况，可以执行 8 AC 3 ，但是会持续比较长的时间，一般无需
执行；

5 ）执行 8 AD 4 执行升级，注意需要填充目标的正确的板卡类型；此时由于需要发送给远
端目标，所以在指令的后面增加 2 个参数（默认填充 0 和 0 ，分别表示目标地址是广播和传播
深度是自动）。

**1. 10. 4. 1. 3.** 文件传输

1 ）执行 8 AD 1 请求下载；
2 ）执行 8 AD 2 分片下载文件；
3 ）执行 8 AC 1 让模组代理转发文件，直到收到+NOTA_URC:PROXY_DONE表示模组代
理转发结束；

4 ）如果需要查询文件的下载情况，可以执行 8 AC 3 ，但是会持续比较长的时间，一般无需
执行；

```
5 ）执行 8 ADB执行提取通知，此时由于需要发送给远端目标，所以在指令的后面增加 2
```

个参数（默认填充 0 和 0 ，分别表示目标地址是广播和传播深度是自动）。

### 1. 10. 4. 2 .NOTA相关指令

**1. 10. 4. 2. 1.** 文件传输协议

### 1. 10. 4. 2. 1. 1. 协议格式

##### 应用-->设备（请求）

```
Bytes 2 2 0 - N 2
Payload CmdId Len Payload CRC 16
```
其中：
CmdID: 命令码;
Len: 仅描述Payload长度，此值为 0 时，表示无payload字段，
高字节先出；


```
Payload: 根据各命令定义，携带负载数据；
CRC 16 : 计算CmdId字段至Payload字段（含）的检验和，高字节先出。
```
设备-->应用（回复）
Bytes 2 2 0 - N 2
Payload CmdId Len Payload CRC 16

其中：
CmdID: 命令码;
Len: 仅描述Payload长度，此值为 0 时，表示无payload字段，
高字节先出；
Payload: 根据各命令定义，携带负载数据；
CRC 16 : 计算CmdId字段至Payload字段（含）的检验和，高字节先出。

说明：
1 .CRC 16 生成多项式CRC 16 - Modbus（ 0 x 8005 ） x 16 +x 15 +x 2 + 1 。
uint 16 _t crc 16 _modbus(const uint 8 _t *src,size_t len)
{
uint 16 _t crc= 0 xFFFF; // 初始值
uint 16 _t poly = 0 xA 001 ; // CRC 16 - MODBUS多项式 ( 0 x 8005 的反转)
for(size_ti = 0 ; i< len; i++) {
crc^= (uint 16 _t)src[i];
for(intj = 0 ; j< 8 ; j++) {
if (crc& 0 x 0001 ){
crc= (crc >> 1 )^ poly;
} else {
crc= crc >> 1 ;
}
}
}
returncrc;
}

### 1. 10. 4. 2. 1. 2. 命令表

##### 目前定义了与文件传输和升级相关的命令，如下表：


##### 命令码 描述

0 x 8 A 0 xD (^0) 查询设备信息
0 x 8 A 0 xD (^1) 文件下载请求
0 x 8 A 0 xD (^2) 下载文件
0 x 8 A 0 xD (^3) 查询文件下载状态
0 x 8 A 0 xD (^4) 执行升级
0 x 8 A 0 xD (^5) 重置状态
0 x 8 A 0 xDA 转发文件
0 x 8 A 0 xDB 上位机文件提取通知
0 x 8 A 0 xC (^0) 查询MD 5 信息
0 x 8 A 0 xC (^1) 代理转发文件
0 x 8 A 0 xC (^2) 传统转发文件
0 x 8 A 0 xC (^3) 代理查询文件MD 5
0 x 8 A 0 xC (^4) 代理查询版本

### 1. 10. 4. 2. 1. 3. 执行结果

##### 状态码 描述

0 x (^00) 操作成功
0 x (^01) 非法参数
0 x 02 Flash读取失败
0 x (^03) Flash擦除失败
0 x (^04) Flash写入失败
0 x (^05) 完整性校验错误
0 x (^06) CRC校验出错
0 x (^07) 不支持此命令
0 x (^08) 操作失败


0 x (^10) 接收完成
0 x (^11) 等待接收数据包
0 x (^12) 接收错误
0 x (^13) 接收超时
0 x (^14) （拒绝升级）不支持此Image类型
0 x (^15) （拒绝升级）差分包存放空间不足
0 x (^16) （拒绝升级）源版本不一致
0 x (^17) （拒绝升级）设备类型不一致
0 x 18 （拒绝升级）上位机主动拒绝
0 x (^19) 超时，执行自动升级
0 x 1 A (拒绝升级）当前已为目标版本
0 x 1 B (拒绝升级）升级文件校验失败
0 x (^30) 升级准备就绪
0 x (^31) 升级成功
0 x (^32) 升级失败
0 x (^40) 文件提取超时
（上位机提取超时，模组不再保证文件完
整性）
0 x (^41) 上位机提取文件失败
0 x (^42) 上位机正在提取文件
0 xEE 处于非升级模式状态

### 1. 10. 4. 2. 1. 4. 查询设备信息（ 0 x 8 A 0 xD 0 ）

##### 应用-->设备（请求）

```
Bits 4 4
Payload SumGrp Grp
```

```
SumGrp : 表示分批回复的总组数，当为 0 时表示立刻回复；
Grp ：表示采用短地址对Sum取模，当为Grp时才回复；
```
设备-->应用（回复）
Bytes 1 1 4 4 1 2
Payload Status Option AppVer PatchZone WriteGran BlVer

Payload为设备信息，内容格式v 0. 0 见下表，高字节先出：
数据内容 字节数 数据 含义
Status 1 参见执行结果章节 状态码

Option (^1) Bit 7 ~ 6 ：数据版本
00 ：格式v 0. 0
Bit 5 ~ 0 ：（保留、填 0 ）

##### 操作字

AppVer (^4) 主版本号（ 2 Bits）
Bit 31 ~ 30
App软件版本
次版本号（ 4 Bits）
Bit 29 ~ 26
小版本号（ 5 Bits）
Bit 25 ~ 21
设备类型（ 21 Bits）
Bit 20 ~ 0

##### 0 :TP 1107 _MP 30

##### 1 :TP 1109

##### 2 :TP 1107 _MP 30 L

##### 3 :TP 1107

##### 4 :TP 1107 _MP 33

##### 5 :TP 1107 _MP 36

##### 6 :TP 1109 _MP 36

PatchZone (^4) 文件缓存空间大小 单位：字节
WriteGran (^1) Bit 7 ~Bit 5 ：写入粒度
0 ： 1 Byte
1 ： 2 Bytes
2 ： 4 Bytes
Flash写入对齐单位


```
3 ： 8 Bytes
4 ： 16 Bytes
5 ： 32 Bytes
6 ： 64 Bytes
7 ： 128 Bytes
Bit 4 ~Bit 0 ：保留
```
BlVer (^2) 主版本号（ 2 Bits）
Bit 15 ~ 14
Bootloader软件版本
次版本号（ 4 Bits）
Bit 13 ~ 10
小版本号（ 5 Bits）
Bit 9 ~ 5
保留（ 5 Bits）
Bit 4 ~ 0

### 1. 10. 4. 2. 1. 5. 下载请求（ 0 x 8 A 0 xD 1 ）

##### 应用-->设备（请求）

Bytes 1 4 2 16
Payload Option TotalLen ChunkSize 检验码

Payload为文件描述信息，内容格式v 0 见下表：
数据内容 字节数 数据 含义
Option 1 Bit 7 ~ 6 ：数据版本
00 ：格式v 0
Bit 5 ：检验码类型
0 ：MD 5
1 ：CRC 32
4 ~ 0 ：（保留、填 0 ）

##### 操作字

TotalLen (^4) 文件总大小 单位：字节
高位先出


ChunkSize (^2) 分片大小 单位：字节
高位先出
检验码^16 OptionBit^4 =^0
MD (^5) 检验码

##### 字节流

```
OptionBit 4 = 1
CRC 32 检验码
算法：CRC- 32 - IEEE
```
##### 保留字节，填 0

##### 设备-->应用（回复），广播接收时无需回复

```
Bytes 1 0
Payload Status 无
```
Status：参见执行结果章节。

### 1. 10. 4. 2. 1. 6. 下载文件（ 0 x 8 A 0 xD 2 ）

##### 应用-->设备（请求）

```
Bytes 4 2 N
Payload AddrOffset DataLen Data
```
其中：
AddrOffset: 目标文件读取的偏移地址，高位先出；
DataLen: 仅Data段的数据长度，高位先出，最大 256 Bytes；
Data: 要传输的目标数据段，字节流；
注：分片数据长度DataLen需对齐WriteGran字段Flash最小写入粒度。

##### 不需要回复；

### 1. 10. 4. 2. 1. 7. 查询文件下载状态（ 0 x 8 A 0 xD 3 ）

##### 应用-->设备（请求）

```
Bytes 0
Payload 无
```

##### 设备-->应用（回复）广播接收时无需回复

```
Bytes 1 N 4 4
Payload Status 表示分片
BitMap
```
##### 总分片数

##### 当前收到

##### 的分片数

Status：参见执行结果章节。

### 1. 10. 4. 2. 1. 8. 执行升级（ 0 x 8 A 0 xD 4 ）

##### 应用-->设备（请求）

```
Bytes 4 2 16
Payload SrcVer DestVer MD 5
```
##### 其中：

Payload为文件描述信息，内容格式v 0 见下表：
数据内容 字节数 数据 含义

SrcVer (^4) 主版本号（ 2 Bits）
Bit 31 ~ 30

##### 源版本

```
次版本号（ 4 Bits）
Bit 29 ~ 26
小版本号（ 5 Bits）
Bit 25 ~ 21
设备类型（ 21 Bits）
Bit 20 ~ 0
```
##### 0 :TP 1107 _MP 30

##### 1 :TP 1109

##### 2 :TP 1107 _MP 30 L

##### 3 :TP 1107

##### 4 :TP 1107 _MP 33

##### 5 :TP 1107 _MP 36

##### 6 :TP 1109 _MP 36

DestVer (^2) 主版本号（ 2 Bits）
Bit 15 ~ 14

##### 目标版本

```
次版本号（ 4 Bits）
```

```
Bit 13 ~ 10
小版本号（ 5 Bits）
Bit 9 ~ 5
保留（ 5 Bits）
Bit 4 ~ 0
```
MD (^516) 对应的升级文件MD 5

##### 设备-->应用（回复）广播接收时无需回复

```
Bytes 1 0
Payload Status 无
```
Status：参见执行结果章节。

### 1. 10. 4. 2. 1. 9. 重置状态（ 0 x 8 A 0 xD 5 ）

##### 应用-->设备（请求）

```
Bytes 0
Payload 无
```
##### 无需回复

### 1. 10. 4. 2. 1. 10. 转发文件（ 0 x 8 A 0 xDA）

##### 应用-->设备（请求）

```
Bytes 1 2 0 or 1 0 or 16
Payload fwCount chunkSize ForwardMode MD 5
```
Payload为文件描述信息，内容格式v 0 见下表：
数据内容 字节数 数据 含义

fwCount (^1) 重复转发次数 若fwCount= 0 ，则使用默
认值 3
chunkSize (^2) 分片大小，高位先出


ForwardMode (^1) 转发条件 0 为具备下游节点的节点转
发； 1 为具备转发能力的都
转发；
Md (^516) 需要转发的文件的MD 5

##### 设备-->应用（回复）

```
Bytes 1 0
Payload Status 无
```
Status：参见执行结果章节。

### 1. 10. 4. 2. 1. 11. 上位机文件提取通知（ 0 x 8 A 0 xDB）

##### 应用-->设备（请求）

```
Bytes 1 2
Payload Option NoteAddr
```
Payload为文件描述信息，内容格式v 0 见下表：
数据内容 字节数 数据 含义

Option (^1) 保留，填 0 x 00 操作字
NoteAddr (^2) 节点地址
符合TPMesh地址定义

##### 目标设备的节点地址

##### 设备-->应用（回复）

```
Bytes 1 0
Payload Status 无
```
Status：参见执行结果章节。

### 1. 10. 4. 2. 1. 12. 查询MD 5 信息（ 0 x 8 A 0 xC 0 ）

##### 应用-->设备（请求）

```
Bits 4 4
Payload SumGrp Grp
SumGrp : 表示分批回复的总组数，当为 0 时表示立刻回复；
```

```
Grp ：表示采用短地址对Sum取模，当为Grp时才回复；
```
##### 设备-->应用（回复）

```
Bytes 1 16
Payload Status MD 5
```
Status：参见执行结果章节。
MD 5 如果没有MD 5 则回复全 0.

### 1. 10. 4. 2. 1. 13. 代理转发文件（ 0 x 8 A 0 xC 1 ）

##### 应用-->设备（请求）

```
Bytes 16 1 1 1 1 2
Payload MD 5 MaxHop FwCount FwMode StartHop ChunekSiz
```
```
其中,
MD 5 表示文件的MD 5
MaxHop表示转发的最大跳数
FwCount 转发次数，[ 1 , 3 ]
FwMode 转发模式， [ 0 , 1 ]
StartHop 开始跳数， [ 1 ,MaxHop]
ChunkSize 分片大小
```
##### 设备-->应用（回复）

```
Bytes 1
Payload Status
```
### 1. 10. 4. 2. 1. 14. 传统转发文件（ 0 x 8 A 0 xC 2 ）

##### 应用-->设备（请求）

```
Bytes 16 2 1 1 2
Payload MD 5 Addr FwCount Period ChunkSize
```

##### 其中,

##### MD 5 表示文件的MD 5

```
Addr表示接收文件的节点地址， 0 表示广播
FwCount 转发次数，[ 1 , 3 ]
Period 发送间隔，单位s
ChunkSize 分片大小
```
##### 设备-->应用（回复）

```
Bytes 1
Payload Status
```
### 1. 10. 4. 2. 1. 15. 代理查询文件MD 5 （ 0 x 8 A 0 xC 3 ）

##### 应用-->设备（请求）

##### 其中,

##### MD 5 表示文件的MD 5

```
MaxHop表示转发的最大跳数
SumGrp 表示转发过程中查询的分组数量,[ 0 , 0 x 0 F]， 0 表示单点轮询；
StartHop 开始跳数， [ 1 ,MaxHop]
```
##### 设备-->应用（回复）

```
Bytes 1
Payload Status
```
### 1. 10. 4. 2. 1. 16. 代理查询版本（ 0 x 8 A 0 xC 4 ）

##### 应用-->设备（请求）

```
Bytes 16 1 1 1
Payload MD 5 MaxHop SumGrp StartHop
```

```
Bytes 4 1 1 1
Payload Ver MaxHop SumGrp StartHop
其中,
Ver 表示目标版本信息
MaxHop表示转发的最大跳数
SumGrp 表示转发过程中查询的分组数量,[ 0 , 0 x 0 F]， 0 表示单点轮询；
StartHop 开始跳数， [ 1 ,MaxHop]
```
##### 设备-->应用（回复）

```
Bytes 1
Payload Status
```

##### 官方微信公众号

##### 联系电话： 020 - 32640281 - 815

```
联系邮箱：jx@techphant.net
官方网站：www.techphant.cn
```

