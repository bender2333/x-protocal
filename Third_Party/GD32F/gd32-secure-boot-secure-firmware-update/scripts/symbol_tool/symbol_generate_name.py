from multiprocessing.dummy import current_process
import os
import argparse
import sys
from datetime import datetime

old_lib_lines = 0

#获取当前脚本所在的路径
current_file_path = os.path.dirname(os.path.abspath(__file__))

# rom_map_path      = current_file_path + '/../../Project/GD32F527-EVAL/MDK-ARM/IBL/Gdm32/Listings/ibl.map'
# new_lib_path      = current_file_path + '/../../Export/symbol/ibl_symbol_mbedtls'

mbedtls_fun = {
    "ED25519_verify",
    "__exit",
    "mbedtls_aes_crypt_cbc",
    "mbedtls_aes_crypt_cfb128",
    "mbedtls_aes_crypt_cfb8",
    "mbedtls_aes_crypt_ctr",
    "mbedtls_aes_crypt_ecb",
    "mbedtls_aes_crypt_ofb",
    "mbedtls_aes_free",
    "mbedtls_aes_init",
    "mbedtls_aes_setkey_dec",
    "mbedtls_aes_setkey_enc",
    "mbedtls_arc4_crypt",
    "mbedtls_arc4_free",
    "mbedtls_arc4_init",
    "mbedtls_arc4_setup",
    "mbedtls_asn1_find_named_data",
    "mbedtls_asn1_free_named_data",
    "mbedtls_asn1_free_named_data_list",
    "mbedtls_asn1_get_alg",
    "mbedtls_asn1_get_alg_null",
    "mbedtls_asn1_get_bitstring",
    "mbedtls_asn1_get_bitstring_null",
    "mbedtls_asn1_get_bool",
    "mbedtls_asn1_get_int",
    "mbedtls_asn1_get_len",
    "mbedtls_asn1_get_mpi",
    "mbedtls_asn1_get_sequence_of",
    "mbedtls_asn1_get_tag",
    "mbedtls_asn1_store_named_data",
    "mbedtls_asn1_write_algorithm_identifier",
    "mbedtls_asn1_write_bitstring",
    "mbedtls_asn1_write_bool",
    "mbedtls_asn1_write_ia5_string",
    "mbedtls_asn1_write_int",
    "mbedtls_asn1_write_len",
    "mbedtls_asn1_write_mpi",
    "mbedtls_asn1_write_named_bitstring",
    "mbedtls_asn1_write_null",
    "mbedtls_asn1_write_octet_string",
    "mbedtls_asn1_write_oid",
    "mbedtls_asn1_write_printable_string",
    "mbedtls_asn1_write_raw_buffer",
    "mbedtls_asn1_write_tag",
    "mbedtls_asn1_write_tagged_string",
    "mbedtls_asn1_write_utf8_string",
    "mbedtls_base64_decode",
    "mbedtls_base64_encode",
    "mbedtls_blowfish_crypt_cbc",
    "mbedtls_blowfish_crypt_cfb64",
    "mbedtls_blowfish_crypt_ctr",
    "mbedtls_blowfish_crypt_ecb",
    "mbedtls_blowfish_free",
    "mbedtls_blowfish_init",
    "mbedtls_blowfish_setkey",
    "mbedtls_calloc",
    "mbedtls_camellia_crypt_cbc",
    "mbedtls_camellia_crypt_cfb128",
    "mbedtls_camellia_crypt_ctr",
    "mbedtls_camellia_crypt_ecb",
    "mbedtls_camellia_free",
    "mbedtls_camellia_init",
    "mbedtls_camellia_setkey_dec",
    "mbedtls_camellia_setkey_enc",
    "mbedtls_ccm_auth_decrypt",
    "mbedtls_ccm_encrypt_and_tag",
    "mbedtls_ccm_free",
    "mbedtls_ccm_init",
    "mbedtls_ccm_setkey",
    "mbedtls_ccm_star_auth_decrypt",
    "mbedtls_ccm_star_encrypt_and_tag",
    "mbedtls_cipher_auth_decrypt",
    "mbedtls_cipher_auth_encrypt",
    "mbedtls_cipher_check_tag",
    "mbedtls_cipher_crypt",
    "mbedtls_cipher_finish",
    "mbedtls_cipher_free",
    "mbedtls_cipher_info_from_string",
    "mbedtls_cipher_info_from_type",
    "mbedtls_cipher_info_from_values",
    "mbedtls_cipher_init",
    "mbedtls_cipher_list",
    "mbedtls_cipher_reset",
    "mbedtls_cipher_set_iv",
    "mbedtls_cipher_set_padding_mode",
    "mbedtls_cipher_setkey",
    "mbedtls_cipher_setup",
    "mbedtls_cipher_update",
    "mbedtls_cipher_update_ad",
    "mbedtls_cipher_write_tag",
    "mbedtls_ciphersuite_preference_init",
    "mbedtls_ctr_drbg_free",
    "mbedtls_ctr_drbg_init",
    "mbedtls_ctr_drbg_random",
    "mbedtls_ctr_drbg_random_with_add",
    "mbedtls_ctr_drbg_reseed",
    "mbedtls_ctr_drbg_seed",
    "mbedtls_ctr_drbg_seed_entropy_len",
    "mbedtls_ctr_drbg_set_entropy_len",
    "mbedtls_ctr_drbg_set_prediction_resistance",
    "mbedtls_ctr_drbg_set_reseed_interval",
    "mbedtls_ctr_drbg_update",
    "mbedtls_ctr_drbg_update_ret",
    "mbedtls_des3_crypt_cbc",
    "mbedtls_des3_crypt_ecb",
    "mbedtls_des3_free",
    "mbedtls_des3_init",
    "mbedtls_des3_set2key_dec",
    "mbedtls_des3_set2key_enc",
    "mbedtls_des3_set3key_dec",
    "mbedtls_des3_set3key_enc",
    "mbedtls_des_crypt_cbc",
    "mbedtls_des_crypt_ecb",
    "mbedtls_des_free",
    "mbedtls_des_init",
    "mbedtls_des_key_set_parity",
    "mbedtls_des_setkey_dec",
    "mbedtls_des_setkey_enc",
    "mbedtls_dhm_calc_secret",
    "mbedtls_dhm_free",
    "mbedtls_dhm_init",
    "mbedtls_dhm_make_params",
    "mbedtls_dhm_make_public",
    "mbedtls_dhm_parse_dhm",
    "mbedtls_dhm_read_params",
    "mbedtls_dhm_read_public",
    "mbedtls_dhm_set_group",
    "mbedtls_ecdh_calc_secret",
    "mbedtls_ecdh_compute_shared",
    "mbedtls_ecdh_free",
    "mbedtls_ecdh_gen_public",
    "mbedtls_ecdh_get_params",
    "mbedtls_ecdh_init",
    "mbedtls_ecdh_make_params",
    "mbedtls_ecdh_make_public",
    "mbedtls_ecdh_read_params",
    "mbedtls_ecdh_read_public",
    "mbedtls_ecdh_setup",
    "mbedtls_ecdsa_free",
    "mbedtls_ecdsa_from_keypair",
    "mbedtls_ecdsa_genkey",
    "mbedtls_ecdsa_init",
    "mbedtls_ecdsa_read_signature",
    "mbedtls_ecdsa_read_signature_restartable",
    "mbedtls_ecdsa_sign",
    "mbedtls_ecdsa_sign_det",
    "mbedtls_ecdsa_verify",
    "mbedtls_ecdsa_write_signature",
    "mbedtls_ecdsa_write_signature_det",
    "mbedtls_ecdsa_write_signature_restartable",
    "mbedtls_ecjpake_check",
    "mbedtls_ecjpake_derive_secret",
    "mbedtls_ecjpake_free",
    "mbedtls_ecjpake_init",
    "mbedtls_ecjpake_read_round_one",
    "mbedtls_ecjpake_read_round_two",
    "mbedtls_ecjpake_setup",
    "mbedtls_ecjpake_write_round_one",
    "mbedtls_ecjpake_write_round_two",
    "mbedtls_ecp_check_privkey",
    "mbedtls_ecp_check_pub_priv",
    "mbedtls_ecp_check_pubkey",
    "mbedtls_ecp_copy",
    "mbedtls_ecp_curve_info_from_grp_id",
    "mbedtls_ecp_curve_info_from_name",
    "mbedtls_ecp_curve_info_from_tls_id",
    "mbedtls_ecp_curve_list",
    "mbedtls_ecp_curve_val_init",
    "mbedtls_ecp_gen_key",
    "mbedtls_ecp_gen_keypair",
    "mbedtls_ecp_gen_keypair_base",
    "mbedtls_ecp_gen_privkey",
    "mbedtls_ecp_group_copy",
    "mbedtls_ecp_group_free",
    "mbedtls_ecp_group_init",
    "mbedtls_ecp_group_load",
    "mbedtls_ecp_grp_id_list",
    "mbedtls_ecp_is_zero",
    "mbedtls_ecp_keypair_free",
    "mbedtls_ecp_keypair_init",
    "mbedtls_ecp_mul",
    "mbedtls_ecp_mul_restartable",
    "mbedtls_ecp_muladd",
    "mbedtls_ecp_muladd_restartable",
    "mbedtls_ecp_point_cmp",
    "mbedtls_ecp_point_free",
    "mbedtls_ecp_point_init",
    "mbedtls_ecp_point_read_binary",
    "mbedtls_ecp_point_read_string",
    "mbedtls_ecp_point_write_binary",
    "mbedtls_ecp_set_zero",
    "mbedtls_ecp_tls_read_group",
    "mbedtls_ecp_tls_read_group_id",
    "mbedtls_ecp_tls_read_point",
    "mbedtls_ecp_tls_write_group",
    "mbedtls_ecp_tls_write_point",
    "mbedtls_entropy_add_source",
    "mbedtls_entropy_free",
    "mbedtls_entropy_func",
    "mbedtls_entropy_gather",
    "mbedtls_entropy_init",
    "mbedtls_entropy_update_manual",
    "mbedtls_free",
    "mbedtls_gcm_auth_decrypt",
    "mbedtls_gcm_crypt_and_tag",
    "mbedtls_gcm_finish",
    "mbedtls_gcm_free",
    "mbedtls_gcm_init",
    "mbedtls_gcm_setkey",
    "mbedtls_gcm_starts",
    "mbedtls_gcm_update",
    "mbedtls_hardware_poll",
    "mbedtls_hkdf",
    "mbedtls_hkdf_expand",
    "mbedtls_hkdf_extract",
    "mbedtls_hmac_drbg_free",
    "mbedtls_hmac_drbg_init",
    "mbedtls_hmac_drbg_random",
    "mbedtls_hmac_drbg_random_with_add",
    "mbedtls_hmac_drbg_reseed",
    "mbedtls_hmac_drbg_seed",
    "mbedtls_hmac_drbg_seed_buf",
    "mbedtls_hmac_drbg_set_entropy_len",
    "mbedtls_hmac_drbg_set_prediction_resistance",
    "mbedtls_hmac_drbg_set_reseed_interval",
    "mbedtls_hmac_drbg_update",
    "mbedtls_hmac_drbg_update_ret",
    "mbedtls_internal_md5_process",
    "mbedtls_internal_sha1_process",
    "mbedtls_internal_sha256_process",
    "mbedtls_internal_sha512_process",
    "mbedtls_md",
    "mbedtls_md5",
    "mbedtls_md5_clone",
    "mbedtls_md5_finish",
    "mbedtls_md5_finish_ret",
    "mbedtls_md5_free",
    "mbedtls_md5_init",
    "mbedtls_md5_process",
    "mbedtls_md5_ret",
    "mbedtls_md5_starts",
    "mbedtls_md5_starts_ret",
    "mbedtls_md5_update",
    "mbedtls_md5_update_ret",
    "mbedtls_md_clone",
    "mbedtls_md_finish",
    "mbedtls_md_free",
    "mbedtls_md_get_name",
    "mbedtls_md_get_size",
    "mbedtls_md_get_type",
    "mbedtls_md_hmac",
    "mbedtls_md_hmac_finish",
    "mbedtls_md_hmac_reset",
    "mbedtls_md_hmac_starts",
    "mbedtls_md_hmac_update",
    "mbedtls_md_info_from_string",
    "mbedtls_md_info_from_type",
    "mbedtls_md_init",
    "mbedtls_md_init_ctx",
    "mbedtls_md_list",
    "mbedtls_md_process",
    "mbedtls_md_setup",
    "mbedtls_md_starts",
    "mbedtls_md_update",
    "mbedtls_memory_buffer_alloc_free",
    "mbedtls_memory_buffer_alloc_init",
    "mbedtls_memory_buffer_alloc_verify",
    "mbedtls_memory_buffer_set_verify",
    "mbedtls_mpi_add_abs",
    "mbedtls_mpi_add_int",
    "mbedtls_mpi_add_mpi",
    "mbedtls_mpi_bitlen",
    "mbedtls_mpi_cmp_abs",
    "mbedtls_mpi_cmp_int",
    "mbedtls_mpi_cmp_mpi",
    "mbedtls_mpi_copy",
    "mbedtls_mpi_div_int",
    "mbedtls_mpi_div_mpi",
    "mbedtls_mpi_exp_mod",
    "mbedtls_mpi_exp_mod_sw",
    "mbedtls_mpi_fill_random",
    "mbedtls_mpi_free",
    "mbedtls_mpi_gcd",
    "mbedtls_mpi_gen_prime",
    "mbedtls_mpi_get_bit",
    "mbedtls_mpi_grow",
    "mbedtls_mpi_init",
    "mbedtls_mpi_inv_mod",
    "mbedtls_mpi_is_prime",
    "mbedtls_mpi_is_prime_ext",
    "mbedtls_mpi_lsb",
    "mbedtls_mpi_lset",
    "mbedtls_mpi_mod_int",
    "mbedtls_mpi_mod_mpi",
    "mbedtls_mpi_mul_int",
    "mbedtls_mpi_mul_mpi",
    "mbedtls_mpi_read_binary",
    "mbedtls_mpi_read_string",
    "mbedtls_mpi_safe_cond_assign",
    "mbedtls_mpi_safe_cond_swap",
    "mbedtls_mpi_set_bit",
    "mbedtls_mpi_shift_l",
    "mbedtls_mpi_shift_r",
    "mbedtls_mpi_shrink",
    "mbedtls_mpi_size",
    "mbedtls_mpi_sub_abs",
    "mbedtls_mpi_sub_int",
    "mbedtls_mpi_sub_mpi",
    "mbedtls_mpi_swap",
    "mbedtls_mpi_write_binary",
    "mbedtls_mpi_write_string",
    "mbedtls_oid_get_attr_short_name",
    "mbedtls_oid_get_cipher_alg",
    "mbedtls_oid_get_ec_grp",
    "mbedtls_oid_get_extended_key_usage",
    "mbedtls_oid_get_md_alg",
    "mbedtls_oid_get_md_hmac",
    "mbedtls_oid_get_numeric_string",
    "mbedtls_oid_get_oid_by_ec_grp",
    "mbedtls_oid_get_oid_by_md",
    "mbedtls_oid_get_oid_by_pk_alg",
    "mbedtls_oid_get_oid_by_sig_alg",
    "mbedtls_oid_get_pk_alg",
    "mbedtls_oid_get_pkcs12_pbe_alg",
    "mbedtls_oid_get_sig_alg",
    "mbedtls_oid_get_sig_alg_desc",
    "mbedtls_oid_get_x509_ext_type",
    "mbedtls_pem_free",
    "mbedtls_pem_init",
    "mbedtls_pem_read_buffer",
    "mbedtls_pem_write_buffer",
    "mbedtls_pk_can_do",
    "mbedtls_pk_check_pair",
    "mbedtls_pk_debug",
    "mbedtls_pk_decrypt",
    "mbedtls_pk_encrypt",
    "mbedtls_pk_free",
    "mbedtls_pk_get_bitlen",
    "mbedtls_pk_get_name",
    "mbedtls_pk_get_type",
    "mbedtls_pk_info_from_type",
    "mbedtls_pk_init",
    "mbedtls_pk_parse_key",
    "mbedtls_pk_parse_public_key",
    "mbedtls_pk_parse_subpubkey",
    "mbedtls_pk_setup",
    "mbedtls_pk_setup_rsa_alt",
    "mbedtls_pk_sign",
    "mbedtls_pk_sign_restartable",
    "mbedtls_pk_verify",
    "mbedtls_pk_verify_ext",
    "mbedtls_pk_verify_restartable",
    "mbedtls_pk_write_key_der",
    "mbedtls_pk_write_key_pem",
    "mbedtls_pk_write_pubkey",
    "mbedtls_pk_write_pubkey_der",
    "mbedtls_pk_write_pubkey_pem",
    "mbedtls_pkcs12_derivation",
    "mbedtls_pkcs12_pbe",
    "mbedtls_pkcs12_pbe_sha1_rc4_128",
    "mbedtls_pkcs5_pbes2",
    "mbedtls_pkcs5_pbkdf2_hmac",
    "mbedtls_platform_set_calloc_free",
    "mbedtls_platform_set_hardware_poll",
    "mbedtls_platform_set_printf",
    "mbedtls_platform_set_snprintf",
    "mbedtls_platform_set_time",
    "mbedtls_platform_setup",
    "mbedtls_platform_teardown",
    "mbedtls_platform_zeroize",
    "mbedtls_rsa_check_privkey",
    "mbedtls_rsa_check_pub_priv",
    "mbedtls_rsa_check_pubkey",
    "mbedtls_rsa_complete",
    "mbedtls_rsa_copy",
    "mbedtls_rsa_deduce_crt",
    "mbedtls_rsa_deduce_primes",
    "mbedtls_rsa_deduce_private_exponent",
    "mbedtls_rsa_export",
    "mbedtls_rsa_export_crt",
    "mbedtls_rsa_export_raw",
    "mbedtls_rsa_free",
    "mbedtls_rsa_gen_key",
    "mbedtls_rsa_get_len",
    "mbedtls_rsa_import",
    "mbedtls_rsa_import_raw",
    "mbedtls_rsa_init",
    "mbedtls_rsa_pkcs1_decrypt",
    "mbedtls_rsa_pkcs1_encrypt",
    "mbedtls_rsa_pkcs1_sign",
    "mbedtls_rsa_pkcs1_verify",
    "mbedtls_rsa_private",
    "mbedtls_rsa_private_sw",
    "mbedtls_rsa_public",
    "mbedtls_rsa_rsaes_oaep_decrypt",
    "mbedtls_rsa_rsaes_oaep_encrypt",
    "mbedtls_rsa_rsaes_pkcs1_v15_decrypt",
    "mbedtls_rsa_rsaes_pkcs1_v15_encrypt",
    "mbedtls_rsa_rsassa_pkcs1_v15_sign",
    "mbedtls_rsa_rsassa_pkcs1_v15_verify",
    "mbedtls_rsa_rsassa_pss_sign",
    "mbedtls_rsa_rsassa_pss_verify",
    "mbedtls_rsa_rsassa_pss_verify_ext",
    "mbedtls_rsa_set_padding",
    "mbedtls_rsa_validate_crt",
    "mbedtls_rsa_validate_params",
    "mbedtls_sha1",
    "mbedtls_sha1_clone",
    "mbedtls_sha1_finish",
    "mbedtls_sha1_finish_ret",
    "mbedtls_sha1_free",
    "mbedtls_sha1_init",
    "mbedtls_sha1_process",
    "mbedtls_sha1_ret",
    "mbedtls_sha1_starts",
    "mbedtls_sha1_starts_ret",
    "mbedtls_sha1_update",
    "mbedtls_sha1_update_ret",
    "mbedtls_sha256",
    "mbedtls_sha256_clone",
    "mbedtls_sha256_finish",
    "mbedtls_sha256_finish_ret",
    "mbedtls_sha256_free",
    "mbedtls_sha256_init",
    "mbedtls_sha256_process",
    "mbedtls_sha256_ret",
    "mbedtls_sha256_starts",
    "mbedtls_sha256_starts_ret",
    "mbedtls_sha256_update",
    "mbedtls_sha256_update_ret",
    "mbedtls_sha512",
    "mbedtls_sha512_clone",
    "mbedtls_sha512_finish",
    "mbedtls_sha512_finish_ret",
    "mbedtls_sha512_free",
    "mbedtls_sha512_init",
    "mbedtls_sha512_process",
    "mbedtls_sha512_ret",
    "mbedtls_sha512_starts",
    "mbedtls_sha512_starts_ret",
    "mbedtls_sha512_update",
    "mbedtls_sha512_update_ret",
    "mbedtls_ssl_ciphersuite_from_id",
    "mbedtls_ssl_ciphersuite_from_string",
    "mbedtls_ssl_ciphersuite_uses_ec",
    "mbedtls_ssl_ciphersuite_uses_psk",
    "mbedtls_ssl_get_ciphersuite_id",
    "mbedtls_ssl_get_ciphersuite_name",
    "mbedtls_ssl_get_ciphersuite_sig_alg",
    "mbedtls_ssl_get_ciphersuite_sig_pk_alg",
    "mbedtls_ssl_list_ciphersuites",
    "mbedtls_strerror",
    "mbedtls_time",
    "mbedtls_x509_crl_free",
    "mbedtls_x509_crl_info",
    "mbedtls_x509_crl_init",
    "mbedtls_x509_crl_parse",
    "mbedtls_x509_crl_parse_der",
    "mbedtls_x509_crt_check_extended_key_usage",
    "mbedtls_x509_crt_check_key_usage",
    "mbedtls_x509_crt_free",
    "mbedtls_x509_crt_info",
    "mbedtls_x509_crt_init",
    "mbedtls_x509_crt_is_revoked",
    "mbedtls_x509_crt_parse",
    "mbedtls_x509_crt_parse_der",
    "mbedtls_x509_crt_parse_der_nocopy",
    "mbedtls_x509_crt_verify",
    "mbedtls_x509_crt_verify_info",
    "mbedtls_x509_crt_verify_restartable",
    "mbedtls_x509_crt_verify_with_profile",
    "mbedtls_x509_csr_free",
    "mbedtls_x509_csr_info",
    "mbedtls_x509_csr_init",
    "mbedtls_x509_csr_parse",
    "mbedtls_x509_csr_parse_der",
    "mbedtls_x509_dn_gets",
    "mbedtls_x509_get_alg",
    "mbedtls_x509_get_alg_null",
    "mbedtls_x509_get_ext",
    "mbedtls_x509_get_name",
    "mbedtls_x509_get_rsassa_pss_params",
    "mbedtls_x509_get_serial",
    "mbedtls_x509_get_sig",
    "mbedtls_x509_get_sig_alg",
    "mbedtls_x509_get_time",
    "mbedtls_x509_key_size_helper",
    "mbedtls_x509_serial_gets",
    "mbedtls_x509_set_extension",
    "mbedtls_x509_sig_alg_gets",
    "mbedtls_x509_string_to_names",
    "mbedtls_x509_time_is_future",
    "mbedtls_x509_time_is_past",
    "mbedtls_x509_write_extensions",
    "mbedtls_x509_write_names",
    "mbedtls_x509_write_sig",
    "mbedtls_x509write_crt_der",
    "mbedtls_x509write_crt_free",
    "mbedtls_x509write_crt_init",
    "mbedtls_x509write_crt_pem",
    "mbedtls_x509write_crt_set_authority_key_identifier",
    "mbedtls_x509write_crt_set_basic_constraints",
    "mbedtls_x509write_crt_set_extension",
    "mbedtls_x509write_crt_set_issuer_key",
    "mbedtls_x509write_crt_set_issuer_name",
    "mbedtls_x509write_crt_set_key_usage",
    "mbedtls_x509write_crt_set_md_alg",
    "mbedtls_x509write_crt_set_ns_cert_type",
    "mbedtls_x509write_crt_set_serial",
    "mbedtls_x509write_crt_set_subject_key",
    "mbedtls_x509write_crt_set_subject_key_identifier",
    "mbedtls_x509write_crt_set_subject_name",
    "mbedtls_x509write_crt_set_validity",
    "mbedtls_x509write_crt_set_version",
    "mbedtls_x509write_csr_der",
    "mbedtls_x509write_csr_free",
    "mbedtls_x509write_csr_init",
    "mbedtls_x509write_csr_pem",
    "mbedtls_x509write_csr_set_extension",
    "mbedtls_x509write_csr_set_key",
    "mbedtls_x509write_csr_set_key_usage",
    "mbedtls_x509write_csr_set_md_alg",
    "mbedtls_x509write_csr_set_ns_cert_type",
    "mbedtls_x509write_csr_set_subject_name",
    "mbedtls_xtea_crypt_cbc",
    "mbedtls_xtea_crypt_ecb",
    "mbedtls_xtea_free",
    "mbedtls_xtea_init",
    "mbedtls_xtea_setup",
    "x25519_ge_add",
    "x25519_ge_frombytes_vartime",
    "x25519_ge_p1p1_to_p2",
    "x25519_ge_p1p1_to_p3",
    "x25519_ge_p3_to_cached",
    "x25519_ge_sub",
    "x25519_ge_tobytes",
    "x25519_sc_reduce",
    "mbedtls_hwpka_flag_set",
}

mbedtls_fun_d = {
    "ciphersuite_preference_default",
    "mbedtls_cipher_definitions",
    "mbedtls_ecdsa_info",
    "mbedtls_eckey_info",
    "mbedtls_eckeydh_info",
    "mbedtls_ed25519_info",
    "mbedtls_md5_info",
    "mbedtls_rsa_alt_info",
    "mbedtls_rsa_info",
    "mbedtls_sha1_info",
    "mbedtls_sha224_info",
    "mbedtls_sha256_info",
    "mbedtls_sha384_info",
    "mbedtls_sha512_info",
    "mbedtls_x509_crt_profile_next",
    "mbedtls_x509_crt_profile_suiteb",
}

# function define
# 读取指定行并返回字符串
def read_specific_line(file_path, line_number):
    with open(file_path, 'r', encoding='utf-8') as file:
        for index, line in enumerate(file):
            if index == line_number - 1:
                return line.strip()

# 读取第二个空格后的内容
def find_char_after_second_space(s):
    words = s.split()
    if len(words) >= 3:
        return ' '.join(words[2:])
    else:
        return "字符串中的空格数量不足2个"
# s = "这是一个 用于 测试 的 字符串"
# result = find_char_after_third_space(s)
# print(result)

# 查找文件中指定字符串所在的行数
def find_string_in_file(file_path, target_string):
    with open(file_path, 'r', encoding='utf-8') as file:
        line_number = 0
        for line in file:
            line_number += 1
            if target_string in line:
                return line_number
    return -1

# 获取指定文件的总行数
def get_file_line_num(file_path) :
    old_lib = open(file_path, 'r')
    line_num = 0
    for line in old_lib:
        line_num += 1
    return line_num

# /* function realize */

def do_gen_mbedtls_lib(args):

    rom_map_path      = args.map
    new_lib_path      = args.old_file
    new_file = open(new_lib_path, 'w')

    str_write = '#<SYMDEFS># ARM Linker, 6090000: Last Updated: '
    current_time = datetime.now()
    time_string = current_time.strftime("%Y-%m-%d %H:%M:%S")
    str_write += time_string + '\n'
    new_file.writelines(str_write)

    for old_lib_str in mbedtls_fun :
        try:
            str_in_rom_map_line = find_string_in_file(rom_map_path, '.text.' + old_lib_str + ' ')
            splipt_str = read_specific_line(rom_map_path, str_in_rom_map_line).split()
            addr = int(splipt_str[0], 16) + 1
            addr_str = hex(addr)
            # print(addr_str)
            new_file.writelines(addr_str + ' T ' + old_lib_str + '\n')
        except Exception as e:
            print("err try: ", old_lib_str)

    for old_lib_str in mbedtls_fun_d :
        try:
            str_in_rom_map_line = find_string_in_file(rom_map_path, '.rodata.' + old_lib_str + ' ')
            splipt_str = read_specific_line(rom_map_path, str_in_rom_map_line).split()
            addr = int(splipt_str[0], 16) + 1
            addr_str = hex(addr)
            # print(addr_str)
            new_file.writelines(addr_str + ' D ' + old_lib_str + '\n')
        except Exception as e:
            print("err try: ", old_lib_str)

    new_file.close()

subcmds = {
        'symbol_gen': do_gen_mbedtls_lib,
        }

def args():
    parser = argparse.ArgumentParser()
    subs = parser.add_subparsers(help='subcommand help', dest='subcmd')

    symbol_gen = subs.add_parser('symbol_gen', help='Generate mbedtls library')
    symbol_gen.add_argument('-m', '--map', metavar='filename', required=True, help='Location of the map')
    symbol_gen.add_argument('-o', '--old_file', metavar='filename', required=True, help='Location of the old library file')

    args = parser.parse_args()

    file_path = os.path.abspath( args.map)
    args.map = file_path
    file_path = os.path.abspath( args.old_file)
    args.old_file = file_path

    if args.subcmd is None:
        print('Must specify a subcommand', file=sys.stderr)
        sys.exit(1)

    subcmds[args.subcmd](args)

if __name__ == '__main__':
    args()
